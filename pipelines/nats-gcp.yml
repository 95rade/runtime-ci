---
groups:
- name: nats-gcp
  jobs:
  - upload-stemcell
- name: infrastructure
  jobs:
  - setup-infrastructure

resource_types:
- name: git
  type: docker-image
  source:
    repository: concourse/git-resource

resources:
- name: runtime-ci
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/runtime-ci.git
- name: dobby-env
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/dobby-env.git
    private_key: {{dobby_env_private_key}}
- name: gcp-stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-google-kvm-ubuntu-trusty-go_agent

jobs:
- name: setup-infrastructure
  public: true
  serial_groups: [infrastructure]
  build_logs_to_retain: 100
  plan:
  - get: dobby-env
  - get: runtime-ci
  - task: setup-infrastructure-terraform
    file: runtime-ci/scripts/ci/setup-infrastructure-terraform/task.yml
    input_mapping:
      env-repo: dobby-env
  - put: dobby-env
    params:
      repository: updated-env-repo
  - task: extract-director-creds-from-terraform-env
    file: runtime-ci/scripts/ci/extract-director-creds-from-terraform-env/task.yml
    input_mapping:
      env-repo: updated-env-repo
  - task: bosh-create-env
    file: runtime-ci/scripts/ci/bosh-create-env/task.yml
    input_mapping:
      env-repo: updated-env-repo
      username: username
      password: password
      ca-cert: ca-cert
    params:
      USERNAME_FILE: username
      PASSWORD_FILE: password
      CA_CERT_FILE: ca.pem
      DEPLOYMENT_VAR_FILE: infrastructure/bosh-init/deployment-env-vars.yml
  - put: dobby-env
    params:
      repository: updated-env-repo
  - task: bind-terraform-env-to-r53
    file: runtime-ci/scripts/ci/bind-terraform-env-to-r53/task.yml
    input_mapping:
      env-repo: updated-env-repo
    params:
      AWS_ACCESS_KEY_ID: {{dobby_aws_access_key_id}}
      AWS_SECRET_ACCESS_KEY: {{dobby_aws_secret_access_key}}
      DOMAIN: dobby.cf-app.com

- name: upload-stemcell
  public: true
  build_logs_to_retain: 100
  plan:
  - aggregate:
    - get: runtime-ci
    - get: dobby-env
      passed: [setup-infrastructure]
      trigger: true
    - get: gcp-stemcell
      trigger: true
  - task: extract-director-creds-from-terraform-env
    file: runtime-ci/scripts/ci/extract-director-creds-from-terraform-env/task.yml
    input_mapping:
      env-repo: dobby-env
  - task: bosh-upload-stemcell
    file: runtime-ci/scripts/ci/bosh-upload-stemcell/task.yml
    input_mapping:
      stemcell: gcp-stemcell
    params:
      TARGET_FILE: target
      USERNAME_FILE: username
      PASSWORD_FILE: password
      CA_CERT_FILE: ca-cert
      STEMCELL_NAME: '*.tgz'

