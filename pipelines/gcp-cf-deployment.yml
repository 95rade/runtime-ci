---
groups:
- name: infrastructure
  jobs:
  - setup-infrastructure
  - destroy-infrastructure
- name: cf-deployment
  jobs:
  - create-gcp-bosh-director

resource_types:
- name: terraform
  type: docker-image
  source:
    repository: ljfranklin/terraform-resource

- name: git
  type: docker-image
  source:
    repository: concourse/git-resource

resources:
- name: runtime-ci
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/runtime-ci.git
- name: luna-env
  type: git
  source:
    branch: master
    uri: git@github.com/cloudfoundry/luna-env.git
    private_key: {{luna_env_private_key}}
- name: cf-gcp-infrastructure
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry-incubator/cf-gcp-infrastructure.git
- name: terraform
  type: terraform
  source:
    storage:
      bucket: runtimeci-tfstate
      bucket_path: cf-deployment/
      region_name: us-west-1
      access_key_id: {{aws_access_key}}
      secret_access_key: {{aws_secret_key}}
    terraform_source: github.com/cloudfoundry-incubator/cf-gcp-infrastructure
    vars:
      project: {{project}}
      env_name: &terraform_env_name luna
      region: us-central1
      zones: [us-central1-a, us-central1-b, us-central1-c]
      dns_suffix: luna.cf-app.com
      ssl_cert: {{cf_ssl_cert}}
      ssl_cert_private_key: {{cf_ssl_cert_private_key}}
      service_account_key: {{service_account_json}}

jobs:
- name: setup-infrastructure
  plan:
  - put: terraform
    params:
      env_name: *terraform_env_name
      delete_on_failure: true

- name: destroy-infrastructure
  plan:
  - put: terraform
    params:
      env_name: *terraform_env_name
      action: destroy
    get_params:
      action: destroy

- name: create-gcp-bosh-director
  plan:
  - get: runtime-ci
  - get: luna-env
  - get: cf-gcp-infrastructure
  - get: terraform
  - task: create-gcp-bosh-director
    file: runtime-ci/scripts/ci/create-gcp-bosh-director/task.yml
    input_mapping:
      env-repo: luna-env
