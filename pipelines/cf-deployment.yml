---
groups:
- name: cf-deployment
  jobs:
  - complex-transition-deploy
  - fresh-deploy
  - lite-deploy
  - transition-deploy
  - upgrade-deploy

  - lint-cf-deployment-manifest
  - complex-transition-cats
  - fresh-cats
  - lite-cats
  - transition-cats
  - upgrade-cats
  - upgrade-smoke-tests
  - upgrade-wats
  - complex-transition-rats
  - fresh-rats
  - lite-rats
  - upgrade-rats
  - ops-test
  - unit-test-ops-files
  - unit-test-transition-tools
  - unit-test-update-releases-coverage

  - bless-manifest
  - ship-it-major
  - ship-it-minor
  - ship-it-patch
  - ship-it-major-expedited
  - ship-it-minor-expedited
  - ship-it-patch-expedited
  - release-notes-template
  - transition-record-compatible-versions
- name: dev
  jobs:
  - bless-manifest
  - branch-freshness
  - ensure-transition-env-is-clean
  - ensure-complex-env-is-clean
  - fresh-acquire-pool
  - fresh-cats
  - fresh-delete-deployment
  - fresh-deploy
  - fresh-rats
  - fresh-release-pool-manual
  - legacy-deploy
  - lint-cf-deployment-manifest
  - lite-acquire-pool
  - lite-cats
  - lite-deploy
  - lite-rats
  - lite-release-pool
  - lite-release-pool-manual
  - ops-test
  - ship-it-major
  - ship-it-minor
  - ship-it-patch
  - ship-it-major-expedited
  - ship-it-minor-expedited
  - ship-it-patch-expedited
  - complex-acquire-pool
  - complex-release-pool-manual
  - complex-transition-deploy
  - complex-transition-cats
  - complex-transition-rats
  - complex-transition-delete-deployment
  - transition-acquire-pool
  - transition-cats
  - transition-delete-deployment
  - transition-deploy
  - transition-record-compatible-versions
  - unit-test-ops-files
  - unit-test-transition-tools
  - unit-test-update-releases-coverage
  - upgrade-acquire-pool
  - upgrade-cats
  - upgrade-deploy
  - upgrade-rats
  - upgrade-release-pool
  - upgrade-smoke-tests
  - upgrade-wats
  - stable-acquire-pool
  - stable-deploy
  - stable-smoke-tests
  - stable-semihourly-pool-acquisition
  - stable-periodic-cats
  - stable-release-pool-manual
  - stable-update-cats-cfd-branch
- name: ops
  jobs:
  - unit-test-ops-files
  - unit-test-update-releases-coverage
  - ops-acquire-pool
  - ops-test
- name: up
  jobs:
  - unit-test-ops-files
  - unit-test-update-releases-coverage
  - upgrade-acquire-pool
  - upgrade-cats
  - upgrade-deploy
  - upgrade-rats
  - upgrade-release-pool
  - upgrade-smoke-tests
  - upgrade-wats
  - bless-manifest
- name: fr
  jobs:
  - unit-test-ops-files
  - unit-test-update-releases-coverage
  - fresh-acquire-pool
  - fresh-cats
  - fresh-delete-deployment
  - fresh-deploy
  - fresh-rats
  - fresh-release-pool-manual
  - bless-manifest
- name: li
  jobs:
  - unit-test-ops-files
  - unit-test-update-releases-coverage
  - lite-acquire-pool
  - lite-cats
  - lite-deploy
  - lite-rats
  - lite-release-pool
  - lite-release-pool-manual
  - bless-manifest
- name: tr
  jobs:
  - complex-release-pool-manual
  - ensure-complex-env-is-clean
  - complex-legacy-deploy
  - complex-acquire-pool
  - complex-transition-deploy
  - complex-transition-cats
  - complex-transition-rats
  - complex-transition-delete-deployment

  - transition-release-pool-manual
  - ensure-transition-env-is-clean
  - legacy-deploy
  - transition-acquire-pool
  - transition-cats
  - transition-delete-deployment
  - transition-deploy
  - transition-record-compatible-versions
  - bless-manifest
- name: st
  jobs:
  - stable-acquire-pool
  - stable-deploy
  - stable-smoke-tests
  - stable-semihourly-pool-acquisition
  - stable-periodic-cats
  - stable-release-pool-manual
  - stable-update-cats-cfd-branch

resource_types:
- name: terraform
  type: docker-image
  source:
    repository: ljfranklin/terraform-resource

resources:
- name: complex-legacy-cf-bosh-deployment
  type: bosh-deployment
  source:
    target: https://bosh.dumbledore.cf-app.com:25555
    username: admin
    password: {{dumbledore_bosh_password}}
    deployment: cf
    ignore_ssl: true

- name: windows-stemcell-bosh-release
  type: bosh-io-stemcell
  source:
    name: bosh-aws-xen-hvm-windows2012R2-go_agent

- name: windows-google-stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-google-kvm-windows2012R2-go_agent

- name: complex-legacy-diego-bosh-deployment
  type: bosh-deployment
  source:
    target: https://bosh.dumbledore.cf-app.com:25555
    username: admin
    password: {{dumbledore_bosh_password}}
    deployment: cf-diego
    ignore_ssl: true

- name: complex-legacy-routing-bosh-deployment
  type: bosh-deployment
  source:
    target: https://bosh.dumbledore.cf-app.com:25555
    username: admin
    password: {{dumbledore_bosh_password}}
    deployment: cf-routing
    ignore_ssl: true

- name: legacy-cf-bosh-deployment
  type: bosh-deployment
  source:
    target: https://bosh.minerva.cf-app.com:25555
    username: admin
    password: {{minerva_bosh_password}}
    deployment: cf
    ignore_ssl: true

- name: legacy-diego-bosh-deployment
  type: bosh-deployment
  source:
    target: https://bosh.minerva.cf-app.com:25555
    username: admin
    password: {{minerva_bosh_password}}
    deployment: cf-diego
    ignore_ssl: true

- name: legacy-cf-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/cf-release
- name: legacy-diego-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/diego-release
- name: legacy-garden-runc-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/garden-runc-release
- name: legacy-cflinuxfs2-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/cflinuxfs2-release
- name: legacy-cf-networking-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/cf-networking-release
- name: legacy-grootfs-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/grootfs-release
- name: legacy-routing-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/cf-routing-release

- name: fresh-pool
  type: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: cf-deployment/fresh
    private_key: {{relint_ci_pools_readwrite_deploy_key}}

- name: lite-pool
  type: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: cf-deployment/lite
    private_key: {{relint_ci_pools_readwrite_deploy_key}}

- name: upgrade-pool
  type: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: cf-deployment/upgrade
    private_key: {{relint_ci_pools_readwrite_deploy_key}}

- name: stable-pool
  type: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: cf-deployment/stable
    private_key: {{relint_ci_pools_readwrite_deploy_key}}

- name: complex-pool
  type: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: cf-deployment/complex
    private_key: {{relint_ci_pools_readwrite_deploy_key}}
- name: transition-pool
  type: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: cf-deployment/transition
    private_key: {{relint_ci_pools_readwrite_deploy_key}}
- name: ops-pool
  type: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: cf-deployment/ops
    private_key: {{relint_ci_pools_readwrite_deploy_key}}
- name: minerva-env-stubs-and-vars
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/minerva-env.git
    private_key: {{minerva_env_readwrite_deploy_key}}
- name: dumbledore-env-stubs-and-vars
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/dumbledore-env.git
    private_key: {{dumbledore_env_readwrite_deploy_key}}
- name: aws-stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-aws-xen-hvm-ubuntu-trusty-go_agent
- name: bellatrix-env-director-state
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/bellatrix-env.git
    private_key: {{bellatrix_env_readwrite_deploy_key}}
    paths:
    - bbl-state.json
    - google_account_creds.json
- name: bellatrix-env-vars-store
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/bellatrix-env.git
    private_key: {{bellatrix_env_readwrite_deploy_key}}
    paths:
    - deployment-vars.yml
- name: bellatrix-env-integration-configs
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/bellatrix-env.git
    private_key: {{bellatrix_env_readwrite_deploy_key}}
    paths:
    - integration_config.json
- name: luna-env-director-state
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/luna-env.git
    private_key: {{luna_env_readwrite_deploy_key}}
    paths:
    - bbl-state.json
    - google_account_creds.json
- name: luna-env-integration-configs
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/luna-env.git
    private_key: {{luna_env_readwrite_deploy_key}}
    paths:
    - integration_config.json
    - rats_integration_config.json
- name: luna-env-vars-store
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/luna-env.git
    private_key: {{luna_env_readwrite_deploy_key}}
    paths:
    - deployment-name.yml
    - deployment-vars.yml
    - network-name.yml
    - syslog-vars.yml
    - bbs-key-label.yml
- name: minerva-env-director-state
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/minerva-env.git
    private_key: {{minerva_env_readwrite_deploy_key}}
    paths:
    - bbl-state.json
- name: dumbledore-env-director-state
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/dumbledore-env.git
    private_key: {{dumbledore_env_readwrite_deploy_key}}
    paths:
    - bbl-state.json
- name: trelawney-env-director-state
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/trelawney-env.git
    private_key: {{trelawney_env_readwrite_deploy_key}}
    paths:
    - bbl-state.json
    - google_account_creds.json
- name: half-hourly
  type: time
  source:
    interval: 30m
- name: cf-deployment-concourse-tasks
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks.git
- name: runtime-ci
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/runtime-ci.git
- name: hermione-env-director-state
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/hermione-env.git
    private_key: {{hermione_env_private_key}}
    paths:
    - bbl-state.json
- name: hermione-env-integration-configs
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/hermione-env.git
    private_key: {{hermione_env_private_key}}
    paths:
    - integration_config.json
    - wats_integration_config.json
    - rats_integration_config.json
- name: hermione-env-vars-store
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/hermione-env.git
    private_key: {{hermione_env_private_key}}
    paths:
    - deployment-vars.yml
    - datadog-deployment-vars.yml
    - rds-vars.yml
    - runtime-config.yml
    - confab-timeout-vars.yml
    - scale-windows-cells.yml
- name: hermione-env-turbulence-vars
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/hermione-env.git
    private_key: {{hermione_env_private_key}}
    paths:
    - turbulence-deployment-vars.yml
- name: hermione-env-turbulence-manifest
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/hermione-env.git
    private_key: {{hermione_env_private_key}}
    paths:
    - turbulence.yml
- name: cf-deployment-develop
  type: git
  source:
    branch: develop
    uri: git@github.com:cloudfoundry/cf-deployment.git
    private_key: {{cf_deployment_private_key}}
- name: cf-deployment-transition
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-deployment-transition.git
- name: cf-deployment-transition-compatibility
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/cf-deployment-transition-compatibility.git
    private_key: {{cf_deployment_transition_compatibility_private_key}}
- name: cf-deployment-release-candidate
  type: git
  source:
    branch: release-candidate
    uri: git@github.com:cloudfoundry/cf-deployment.git
    private_key: {{cf_deployment_private_key}}
- name: cf-deployment-all-branches
  type: git
  source:
    branch: develop
    uri: https://github.com/cloudfoundry/cf-deployment.git
- name: cf-release-master
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-release.git
- name: github-diego-release
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/diego-release.git
    tag_filter: v1.*
- name: github-routing-release-master
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry-incubator/routing-release
- name: windows-acceptance-tests
  type: git
  source:
    branch: master
    uri: https://github.com/selzoc/wats
- name: cf-acceptance-tests
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/cf-acceptance-tests.git
    private_key: {{cf_acceptance_tests_private_key}}
- name: cf-deployment-master
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/cf-deployment.git
    private_key: {{cf_deployment_private_key}}
- name: snitch-env-vars-store
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/snitch-env.git
    private_key: {{snitch_env_private_key}}
    paths:
    - deployment-vars.yml
- name: snitch-env-integration-configs
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/snitch-env.git
    private_key: {{snitch_env_private_key}}
    paths:
    - integration_config.json
    - rats_integration_config.json
- name: snitch-env-director-state
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/snitch-env.git
    private_key: {{snitch_env_private_key}}
    paths:
    - google_account_creds.json
    - bbl-state.json
- name: bosh-deployment
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/bosh-deployment.git
- name: cats-concourse-task
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cats-concourse-task.git

- name: cf-deployment-version
  type: semver
  source:
    driver: git
    uri: git@github.com:cloudfoundry/cf-relint-ci-semver.git
    branch: master
    private_key: {{cf_relint_ci_semver_private_key}}
    git_user: "CF MEGA BOT <cf-mega@pivotal.io>"
    file: cf-deployment-version

- name: deliver-tracker-story
  type: tracker
  source:
    token: {{cf_mega_api_token}}
    project_id: "1382120"
    tracker_url: https://www.pivotaltracker.com

jobs:
- name: branch-freshness
  public: true
  build_logs_to_retain: 100
  plan:
  - aggregate:
    - get: cf-deployment-all-branches
      trigger: true
    - get: runtime-ci
  - task: validate-branch-freshness
    file: runtime-ci/scripts/ci/validate-branch-freshness/task.yml
    input_mapping:
      repo: cf-deployment-all-branches

- name: fresh-acquire-pool
  serial: true
  public: true
  plan:
  - aggregate:
    - get: cf-deployment-develop
      trigger: true
      passed: [unit-test-ops-files, unit-test-update-releases-coverage]
    - put: fresh-pool
      params: {acquire: true}

- name: ops-acquire-pool
  serial: true
  public: true
  plan:
  - aggregate:
    - get: cf-deployment-develop
      trigger: true
      passed: [unit-test-ops-files, unit-test-update-releases-coverage]
    - put: ops-pool
      params: {acquire: true}

- name: lite-acquire-pool
  serial: true
  public: true
  plan:
  - aggregate:
    - get: cf-deployment-develop
      trigger: true
      passed: [unit-test-ops-files, unit-test-update-releases-coverage]
    - put: lite-pool
      params: {acquire: true}

- name: lint-cf-deployment-manifest
  serial: false
  public: true
  build_logs_to_retain: 100
  plan:
  - get: cf-deployment-develop
    trigger: true
  - task: lint-manifest
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: relintdockerhubpushbot/cf-deployment-concourse-tasks
      inputs:
      - name: cf-deployment-develop
      run:
        path: /bin/bash
        args:
        - -exc
        - |
          ruby -e "require 'yaml'; YAML.load_file('./cf-deployment-develop/cf-deployment.yml')"

- name: unit-test-ops-files
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - get: cf-deployment-develop
    trigger: true
  - task: unit-test-ops-files
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: relintdockerhubpushbot/bosh-cli
      inputs:
      - name: cf-deployment-develop
      run:
        dir: cf-deployment-develop
        path: scripts/test

- name: unit-test-transition-tools
  serial: false
  public: true
  build_logs_to_retain: 100
  plan:
  - get: cf-deployment-transition
    trigger: true
  - task: unit-test-suite
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: relintdockerhubpushbot/bosh-and-spiff
      inputs:
      - name: cf-deployment-transition
      run:
        path: cf-deployment-transition/test/test-suite.sh

- name: unit-test-update-releases-coverage
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - get: cf-deployment-develop
    trigger: true
  - get: runtime-ci
  - task: unit-test-update-releases-coverage
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: relintdockerhubpushbot/bosh-cli
      inputs:
      - name: cf-deployment-develop
      - name: runtime-ci
      run:
        dir: runtime-ci
        path: scripts/tests/update-releases-coverage-test

- name: transition-acquire-pool
  public: true
  serial: true
  build_logs_to_retain: 10
  plan:
  - timeout: 4h
    do:
    - aggregate:
      - get: cf-deployment-release-candidate
        trigger: true
      - get: legacy-cf-release
        trigger: true
      - get: legacy-diego-release
        trigger: true
      - put: transition-pool
        params: {claim: minerva}

- name: ensure-transition-env-is-clean
  public: true
  serial: true
  build_logs_to_retain: 10
  plan:
  - timeout: 4h
    do:
    - get: transition-pool
      passed: [ transition-acquire-pool ]
      trigger: true
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: minerva-env-director-state
      - get: runtime-ci
    - aggregate:
      - task: guarantee-no-existing-cf-deployment
        file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
        input_mapping:
          bbl-state: minerva-env-director-state
        params:
          BBL_STATE_DIR: bbl-state
      - task: guarantee-no-existing-diego-deployment
        input_mapping:
          bbl-state: minerva-env-director-state
        file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
        params:
          BBL_STATE_DIR: bbl-state
          DEPLOYMENT_NAME: cf-diego
    - aggregate:
      - task: recreate-uaadb
        file: runtime-ci/tasks/recreate-database/task.yml
        input_mapping:
          bbl-state: minerva-env-director-state
        params:
          BBL_STATE_DIR: bbl-state
          DB_HOST: {{minerva_uaadb_host}}
          DB_USER: {{minerva_uaadb_user}}
          DB_PASSWORD: {{minerva_uaadb_password}}
          DB_NAME: {{minerva_uaadb_db_name}}
      - task: recreate-ccdb
        file: runtime-ci/tasks/recreate-database/task.yml
        input_mapping:
          bbl-state: minerva-env-director-state
        params:
          BBL_STATE_DIR: bbl-state
          DB_HOST: {{minerva_ccdb_host}}
          DB_USER: {{minerva_ccdb_user}}
          DB_PASSWORD: {{minerva_ccdb_password}}
          DB_NAME: {{minerva_ccdb_db_name}}
      - task: recreate-bbsdb
        file: runtime-ci/tasks/recreate-database/task.yml
        input_mapping:
          bbl-state: minerva-env-director-state
        params:
          BBL_STATE_DIR: bbl-state
          DB_HOST: {{minerva_bbsdb_host}}
          DB_USER: {{minerva_bbsdb_user}}
          DB_PASSWORD: {{minerva_bbsdb_password}}
          DB_NAME: {{minerva_bbsdb_db_name}}
      - task: recreate-locketdb
        file: runtime-ci/tasks/recreate-database/task.yml
        input_mapping:
          bbl-state: minerva-env-director-state
        params:
          BBL_STATE_DIR: bbl-state
          DB_HOST: {{minerva_locketdb_host}}
          DB_USER: {{minerva_locketdb_user}}
          DB_PASSWORD: {{minerva_locketdb_password}}
          DB_NAME: {{minerva_locketdb_db_name}}
      - task: restore-cloud-config
        file: runtime-ci/tasks/update-cloud-config-from-bbl/task.yml
        input_mapping:
          bbl-state: minerva-env-director-state
        params:
          BBL_STATE_DIR: bbl-state

- name: complex-acquire-pool
  public: true
  serial: true
  build_logs_to_retain: 10
  plan:
  - timeout: 4h
    do:
    - aggregate:
      - get: cf-deployment-release-candidate
        trigger: true
      - get: legacy-cf-release
        trigger: true
      - get: legacy-diego-release
        trigger: true
      - put: complex-pool
        params: {claim: dumbledore}

- name: ensure-complex-env-is-clean
  public: true
  serial: true
  build_logs_to_retain: 10
  plan:
  - timeout: 4h
    do:
    - get: complex-pool
      passed: [ complex-acquire-pool ]
      trigger: true
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: dumbledore-env-director-state
      - get: runtime-ci
    - aggregate:
      - task: guarantee-no-existing-cf-deployment
        input_mapping:
          bbl-state: dumbledore-env-director-state
        file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
      - task: guarantee-no-existing-diego-deployment
        input_mapping:
          bbl-state: dumbledore-env-director-state
        file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
        params:
          DEPLOYMENT_NAME: cf-diego
      - task: guarantee-no-existing-routing-deployment
        input_mapping:
          bbl-state: dumbledore-env-director-state
        file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
        params:
          DEPLOYMENT_NAME: cf-routing
    - aggregate:
      - task: recreate-uaadb
        file: runtime-ci/tasks/recreate-database/task.yml
        input_mapping:
          bbl-state: dumbledore-env-director-state
        params:
          DB_HOST: {{dumbledore_uaadb_host}}
          DB_USER: {{dumbledore_uaadb_user}}
          DB_PASSWORD: {{dumbledore_uaadb_password}}
          DB_NAME: {{dumbledore_uaadb_db_name}}
      - task: recreate-ccdb
        file: runtime-ci/tasks/recreate-database/task.yml
        input_mapping:
          bbl-state: dumbledore-env-director-state
        params:
          DB_HOST: {{dumbledore_ccdb_host}}
          DB_USER: {{dumbledore_ccdb_user}}
          DB_PASSWORD: {{dumbledore_ccdb_password}}
          DB_NAME: {{dumbledore_ccdb_db_name}}
      - task: recreate-npdb
        file: runtime-ci/tasks/recreate-database/task.yml
        input_mapping:
          bbl-state: dumbledore-env-director-state
        params:
          DB_HOST: {{dumbledore_npdb_host}}
          DB_USER: {{dumbledore_npdb_user}}
          DB_PASSWORD: {{dumbledore_npdb_password}}
          DB_NAME: {{dumbledore_npdb_db_name}}
      - task: recreate-ncdb
        file: runtime-ci/tasks/recreate-database/task.yml
        input_mapping:
          bbl-state: dumbledore-env-director-state
        params:
          DB_HOST: {{dumbledore_ncdb_host}}
          DB_USER: {{dumbledore_ncdb_user}}
          DB_PASSWORD: {{dumbledore_ncdb_password}}
          DB_NAME: {{dumbledore_ncdb_db_name}}
      - task: recreate-bbsdb
        file: runtime-ci/tasks/recreate-database/task.yml
        input_mapping:
          bbl-state: dumbledore-env-director-state
        params:
          DB_HOST: {{dumbledore_bbsdb_host}}
          DB_USER: {{dumbledore_bbsdb_user}}
          DB_PASSWORD: {{dumbledore_bbsdb_password}}
          DB_NAME: {{dumbledore_bbsdb_db_name}}
      - task: recreate-routingapidb
        file: runtime-ci/tasks/recreate-database/task.yml
        input_mapping:
          bbl-state: dumbledore-env-director-state
        params:
          DB_HOST: {{dumbledore_routingapidb_host}}
          DB_USER: {{dumbledore_routingapidb_username}}
          DB_PASSWORD: {{dumbledore_routingapidb_password}}
          DB_NAME: {{dumbledore_routingapidb_name}}
      - task: recreate-locketdb
        file: runtime-ci/tasks/recreate-database/task.yml
        input_mapping:
          bbl-state: dumbledore-env-director-state
        params:
          DB_HOST: {{dumbledore_locketdb_host}}
          DB_USER: {{dumbledore_locketdb_username}}
          DB_PASSWORD: {{dumbledore_locketdb_password}}
          DB_NAME: {{dumbledore_locketdb_name}}
    - task: restore-cloud-config
      file: runtime-ci/tasks/update-cloud-config-from-bbl/task.yml
      input_mapping:
        bbl-state: dumbledore-env-director-state

- name: complex-legacy-deploy
  public: true
  serial: true
  build_logs_to_retain: 10
  plan:
  - timeout: 4h
    do:
    - get: complex-pool
      passed: [ ensure-complex-env-is-clean ]
      trigger: true
    - aggregate:
      - get: runtime-ci
      - get: dumbledore-env-stubs-and-vars
      - get: dumbledore-env-director-state
      - get: cf-release-master
        params:
          depth: 1
          submodules: none
      - get: github-diego-release
      - get: github-routing-release-master
      - get: legacy-garden-runc-release
      - get: legacy-diego-release
      - get: legacy-cflinuxfs2-release
      - get: legacy-grootfs-release
      - get: legacy-cf-networking-release
      - get: legacy-cf-release
      - get: legacy-routing-release
      - get: aws-stemcell
      - get: cf-deployment-transition
    - task: generate-release-manifest-cf-no-routing
      file: runtime-ci/scripts/ci/generate-release-manifest/task.yml
      input_mapping:
        release-repo: cf-release-master
        stubs-repo: dumbledore-env-stubs-and-vars
      params:
        INFRASTRUCTURE: aws
        STUBS_PATH: transition/stubs/cf/cf-stub-no-routing.yml
      output_mapping:
        manifest: cf-manifest-no-routing
    - task: generate-release-manifest-cf-with-routing
      file: runtime-ci/scripts/ci/generate-release-manifest/task.yml
      input_mapping:
        release-repo: cf-release-master
        stubs-repo: dumbledore-env-stubs-and-vars
      params:
        INFRASTRUCTURE: aws
        STUBS_PATH: transition/stubs/cf/cf-stub.yml
      output_mapping:
        manifest: cf-manifest
    - task: create-diego-manifest
      file: runtime-ci/scripts/ci/create-diego-manifest-with-config/task.yml
      input_mapping:
        diego-release: github-diego-release
        config: dumbledore-env-stubs-and-vars
        iaas-settings: dumbledore-env-stubs-and-vars
      output_mapping:
        generated-diego-manifest: diego-manifest
      params:
        IAAS_SETTINGS_PATH: transition/stubs/diego/iaas-settings.yml
        PROPERTY_OVERRIDES_PATH: transition/stubs/diego/property-overrides.yml
        INSTANCE_COUNT_OVERRIDES_PATH: transition/stubs/diego/instance-count-overrides.yml
        RELEASE_VERSIONS_PATH: transition/stubs/diego/release-versions.yml
        CF_NETWORKING_OVERRIDES_PATH: transition/stubs/diego/cf-networking.yml
        USE_ETCD: false
        USE_MYSQL: true
        DIEGO_MYSQL_OVERRIDES_PATH: transition/stubs/diego/rds-overrides.yml
        USE_GROOTFS: true
        USE_LOCKET: true
    - task: generate-routing-manifest
      file: runtime-ci/tasks/generate-routing-manifest/task.yml
      input_mapping:
        routing-release: github-routing-release-master
        stubs-repo: dumbledore-env-stubs-and-vars
      params:
        CF_MANIFEST_PATH: cf-manifest/deployment.yml
        DIEGO_MANIFEST_PATH: diego-manifest/diego-deployment.yml
        PROPERTY_OVERRIDES_PATH: stubs-repo/transition/stubs/routing/property-overrides.yml
        IAAS_SETTINGS_PATH: stubs-repo/transition/stubs/routing/iaas-settings.yml
        PERSISTENT_DISK_OVERRIDES_PATH: stubs-repo/transition/stubs/routing/persistent-disk-overrides.yml
        INSTANCE_COUNT_OVERRIDES_PATH: stubs-repo/transition/stubs/routing/instance-count-overrides.yml
    - put: complex-legacy-cf-bosh-deployment
      params:
        manifest: cf-manifest-no-routing/deployment.yml
        stemcells: [aws-stemcell/*.tgz]
        releases:
        - legacy-cf-release/release.tgz
    - put: complex-legacy-diego-bosh-deployment
      params:
        manifest: diego-manifest/diego-deployment.yml
        stemcells: [aws-stemcell/*.tgz]
        releases:
        - legacy-diego-release/release.tgz
        - legacy-garden-runc-release/release.tgz
        - legacy-cflinuxfs2-release/release.tgz
        - legacy-grootfs-release/release.tgz
        - legacy-cf-networking-release/release.tgz
    - put: complex-legacy-routing-bosh-deployment
      params:
        manifest: routing-manifest/routing-deployment.yml
        stemcells: [aws-stemcell/*.tgz]
        releases:
        - legacy-routing-release/release.tgz
    - put: complex-legacy-cf-bosh-deployment
      params:
        manifest: cf-manifest/deployment.yml
        stemcells: [aws-stemcell/*.tgz]
        releases:
        - legacy-cf-release/release.tgz
    - task: bosh-run-errand-smoke-tests
      file: runtime-ci/tasks/run-errand/task.yml
      input_mapping:
        bbl-state: dumbledore-env-director-state
      params:
        ERRAND_NAME: smoke_tests
    - task: run-routing-smoke-tests
      input_mapping:
        routing-release: github-routing-release-master
        integration-config: dumbledore-env-stubs-and-vars
      params:
        NODES: 1
        PACKAGES: "smoke_tests"
      file: runtime-ci/scripts/ci/run-rats/task.yml

- name: legacy-deploy
  public: true
  serial: true
  build_logs_to_retain: 10
  plan:
  - timeout: 4h
    do:
    - get: transition-pool
      passed: [ ensure-transition-env-is-clean ]
      trigger: true
    - aggregate:
      - get: runtime-ci
      - get: minerva-env-stubs-and-vars
      - get: minerva-env-director-state
      - get: cf-release-master
        params:
          depth: 1
          submodules: none
      - get: github-diego-release
      - get: legacy-garden-runc-release
      - get: legacy-diego-release
      - get: legacy-cflinuxfs2-release
      - get: legacy-cf-release
      - get: aws-stemcell
      - get: cf-deployment-transition
    - task: generate-release-manifest-cf
      file: runtime-ci/scripts/ci/generate-release-manifest/task.yml
      input_mapping:
        release-repo: cf-release-master
        stubs-repo: minerva-env-stubs-and-vars
      params:
        INFRASTRUCTURE: aws
        STUBS_PATH: transition/stubs/cf/cf-stub.yml
      output_mapping:
        manifest: cf-manifest
    - task: create-diego-manifest
      file: runtime-ci/scripts/ci/create-diego-manifest/task.yml
      input_mapping:
        diego-release: github-diego-release
        iaas-settings: minerva-env-stubs-and-vars
        property-overrides: minerva-env-stubs-and-vars
        instance-count-overrides: minerva-env-stubs-and-vars
        release-versions: minerva-env-stubs-and-vars
      output_mapping:
        generated-diego-manifest: diego-manifest
      params:
        IAAS_SETTINGS_PATH: transition/stubs/diego/iaas-settings.yml
        INSTANCE_COUNT_OVERRIDES_PATH: transition/stubs/diego/instance-count-overrides.yml
        DIEGO_SQL_RESOURCE_PATH: property-overrides/transition/stubs/diego/rds-overrides.yml
        PROPERTY_OVERRIDES_PATH: transition/stubs/diego/property-overrides.yml
        RELEASE_VERSIONS_PATH: transition/stubs/diego/release-versions.yml
    - put: legacy-cf-bosh-deployment
      params:
        manifest: cf-manifest/deployment.yml
        stemcells: [aws-stemcell/*.tgz]
        releases:
        - legacy-cf-release/release.tgz
    - put: legacy-diego-bosh-deployment
      params:
        manifest: diego-manifest/diego-deployment.yml
        stemcells: [aws-stemcell/*.tgz]
        releases:
        - legacy-diego-release/release.tgz
        - legacy-garden-runc-release/release.tgz
        - legacy-cflinuxfs2-release/release.tgz
    - task: bosh-run-errand-smoke-tests
      file: runtime-ci/tasks/run-errand/task.yml
      input_mapping:
        bbl-state: minerva-env-director-state
      params:
        BBL_STATE_DIR: bbl-state
        ERRAND_NAME: smoke_tests

- name: complex-transition-deploy
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: complex-pool
      passed: [ complex-legacy-deploy ]
      trigger: true
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: dumbledore-env-stubs-and-vars
      - get: dumbledore-env-director-state
      - get: cf-deployment-release-candidate
        passed: [ bless-manifest ]
      - get: legacy-cf-release
        passed: [ complex-legacy-deploy ]
        params:
          tarball: false
      - get: legacy-diego-release
        passed: [ complex-legacy-deploy ]
        params:
          tarball: false
      - get: legacy-cflinuxfs2-release
        passed: [ complex-legacy-deploy ]
        params:
          tarball: false
      - get: legacy-garden-runc-release
        passed: [ complex-legacy-deploy ]
        params:
          tarball: false
      - get: legacy-cf-networking-release
        passed: [ complex-legacy-deploy ]
        params:
          tarball: false
      - get: legacy-grootfs-release
        passed: [ complex-legacy-deploy ]
        params:
          tarball: false
      - get: legacy-routing-release
        passed: [ complex-legacy-deploy ]
        params:
          tarball: false
      - get: cf-deployment-transition
    - task: extract-vars-store
      file: runtime-ci/tasks/r2d2/task.yml
      input_mapping:
        bbl-state: dumbledore-env-director-state
        vars-store: dumbledore-env-stubs-and-vars
      params:
        EXTRACT_CF_NETWORKING: true
        EXTRACT_ROUTING: true
    - task: bosh-upload-stemcell
      file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
      input_mapping:
        cf-deployment: cf-deployment-release-candidate
        bbl-state: dumbledore-env-director-state
      params:
        INFRASTRUCTURE: aws
    - task: add-tcp-domain
      file: runtime-ci/tasks/add-tcp-domain/task.yml
      input_mapping:
        vars-store: dumbledore-env-stubs-and-vars
      params:
        SYSTEM_DOMAIN: dumbledore.cf-app.com
    - task: collect-ops-files
      file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
      input_mapping:
        base-ops-files: cf-deployment-release-candidate
        new-ops-files: cf-deployment-transition
      params:
        BASE_OPS_FILE_DIR: "operations"
        NEW_OPS_FILES: |
          cfr-to-cfd.yml
          enable-doppler-announce.yml
          keep-etcd-for-transition.yml
          keep-syslog-drain-binder-for-transition.yml
          opt-out-of-cf-syslog-drain-release-for-transition.yml
    - task: bosh-deploy-cf
      file: runtime-ci/tasks/transition-deploy/task.yml
      input_mapping:
        bbl-state: dumbledore-env-director-state
        cf-deployment: cf-deployment-release-candidate
        ops-files: collected-ops-files
        vars-store: extracted-vars-store
        vars-files: dumbledore-env-stubs-and-vars
      params:
        SYSTEM_DOMAIN: dumbledore.cf-app.com
        UPTIMER_APP_DOMAIN: apps.dumbledore.cf-app.com
        UPTIMER_RUN_SYSLOG_MEASUREMENT: true
        UPTIMER_TCP_DOMAIN: tcp.dumbledore.cf-app.com
        FAIL_ON_DOWNTIME: true
        OPS_FILES: |
          operations/use-compiled-releases.yml
          operations/aws.yml
          operations/legacy/keep-static-ips.yml
          operations/use-external-dbs.yml
          operations/experimental/skip-consul-locks.yml
          operations/experimental/skip-consul-cell-registrations.yml
          operations/use-s3-blobstore.yml
          operations/use-blobstore-cdn.yml
          operations/set-bbs-active-key.yml
          operations/cfr-to-cfd.yml
          operations/experimental/use-grootfs.yml
          operations/keep-etcd-for-transition.yml
          operations/enable-doppler-announce.yml
          operations/keep-syslog-drain-binder-for-transition.yml
          operations/opt-out-of-cf-syslog-drain-release-for-transition.yml
          operations/override-app-domains.yml
        VARS_FILES: |
          rds-vars.yml
          s3-vars.yml
          cdn-vars.yml
          static_ips.yml
          app_domains_vars.yml
        RUMP_DEPLOYMENTS: "cf-diego cf-routing"
      on_failure:
        put: dumbledore-env-stubs-and-vars
        params:
          repository: updated-vars-store
          rebase: true
    - task: bosh-deploy-cf-with-cf-syslog-drain-release
      file: runtime-ci/tasks/transition-deploy/task.yml
      input_mapping:
        bbl-state: dumbledore-env-director-state
        cf-deployment: cf-deployment-release-candidate
        ops-files: collected-ops-files
        vars-store: updated-vars-store
        vars-files: dumbledore-env-stubs-and-vars
      params:
        SYSTEM_DOMAIN: dumbledore.cf-app.com
        UPTIMER_APP_DOMAIN: apps.dumbledore.cf-app.com
        UPTIMER_RUN_SYSLOG_MEASUREMENT: true
        UPTIMER_TCP_DOMAIN: tcp.dumbledore.cf-app.com
        FAIL_ON_DOWNTIME: true
        OPS_FILES: |
          operations/use-compiled-releases.yml
          operations/aws.yml
          operations/legacy/keep-static-ips.yml
          operations/use-external-dbs.yml
          operations/experimental/skip-consul-locks.yml
          operations/experimental/skip-consul-cell-registrations.yml
          operations/use-s3-blobstore.yml
          operations/use-blobstore-cdn.yml
          operations/set-bbs-active-key.yml
          operations/cfr-to-cfd.yml
          operations/experimental/use-grootfs.yml
          operations/keep-etcd-for-transition.yml
          operations/enable-doppler-announce.yml
          operations/keep-syslog-drain-binder-for-transition.yml
          operations/override-app-domains.yml
        VARS_FILES: |
          rds-vars.yml
          s3-vars.yml
          cdn-vars.yml
          static_ips.yml
          app_domains_vars.yml
        RUMP_DEPLOYMENTS: "cf-diego cf-routing"
      on_failure:
        put: dumbledore-env-stubs-and-vars
        params:
          repository: updated-vars-store
          rebase: true
    - task: bosh-deploy-cf-without-doppler-announce
      file: runtime-ci/tasks/transition-deploy/task.yml
      input_mapping:
        bbl-state: dumbledore-env-director-state
        cf-deployment: cf-deployment-release-candidate
        ops-files: collected-ops-files
        vars-store: updated-vars-store
        vars-files: dumbledore-env-stubs-and-vars
      params:
        SYSTEM_DOMAIN: dumbledore.cf-app.com
        UPTIMER_APP_DOMAIN: apps.dumbledore.cf-app.com
        UPTIMER_RUN_SYSLOG_MEASUREMENT: true
        UPTIMER_TCP_DOMAIN: tcp.dumbledore.cf-app.com
        FAIL_ON_DOWNTIME: true
        OPS_FILES: |
          operations/use-compiled-releases.yml
          operations/aws.yml
          operations/legacy/keep-static-ips.yml
          operations/use-external-dbs.yml
          operations/experimental/skip-consul-locks.yml
          operations/experimental/skip-consul-cell-registrations.yml
          operations/use-s3-blobstore.yml
          operations/use-blobstore-cdn.yml
          operations/set-bbs-active-key.yml
          operations/cfr-to-cfd.yml
          operations/experimental/use-grootfs.yml
          operations/keep-etcd-for-transition.yml
          operations/override-app-domains.yml
        VARS_FILES: |
          rds-vars.yml
          s3-vars.yml
          cdn-vars.yml
          static_ips.yml
          app_domains_vars.yml
        RUMP_DEPLOYMENTS: "cf-diego cf-routing"
      on_failure:
        put: dumbledore-env-stubs-and-vars
        params:
          repository: updated-vars-store
          rebase: true
    - task: remove-static-ips-from-cloud-config
      file: runtime-ci/tasks/bosh-extend-cloud-config/task.yml
      input_mapping:
        bbl-state: dumbledore-env-director-state
        ops-file: dumbledore-env-stubs-and-vars
      params:
        OPS_FILE_PATH: add-static-ips-to-dynamic-range.yml
    - task: bosh-deploy-cf-without-etcd
      file: runtime-ci/tasks/transition-deploy/task.yml
      input_mapping:
        bbl-state: dumbledore-env-director-state
        cf-deployment: cf-deployment-release-candidate
        ops-files: collected-ops-files
        vars-store: updated-vars-store
        vars-files: dumbledore-env-stubs-and-vars
      params:
        SYSTEM_DOMAIN: dumbledore.cf-app.com
        UPTIMER_APP_DOMAIN: apps.dumbledore.cf-app.com
        UPTIMER_RUN_SYSLOG_MEASUREMENT: true
        UPTIMER_TCP_DOMAIN: tcp.dumbledore.cf-app.com
        OPS_FILES: |
          operations/use-compiled-releases.yml
          operations/aws.yml
          operations/use-external-dbs.yml
          operations/experimental/skip-consul-locks.yml
          operations/experimental/skip-consul-cell-registrations.yml
          operations/use-s3-blobstore.yml
          operations/use-blobstore-cdn.yml
          operations/set-bbs-active-key.yml
          operations/experimental/use-grootfs.yml
          operations/override-app-domains.yml
        VARS_FILES: |
          rds-vars.yml
          s3-vars.yml
          cdn-vars.yml
          app_domains_vars.yml
        RUMP_DEPLOYMENTS: "cf-routing"
        FAIL_ON_DOWNTIME: true
      ensure:
        put: dumbledore-env-stubs-and-vars
        params:
          repository: updated-vars-store
          rebase: true
    - task: run-bosh-cleanup
      file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
      input_mapping:
        bbl-state: dumbledore-env-stubs-and-vars
    - task: update-integration-configs
      file: cf-deployment-concourse-tasks/update-integration-configs/task.yml
      params:
        CATS_INTEGRATION_CONFIG_FILE: integration_config.json
      input_mapping:
        vars-store: updated-vars-store
        integration-configs: dumbledore-env-stubs-and-vars
      ensure:
        put: dumbledore-env-stubs-and-vars
        params:
          repository: updated-integration-configs
          rebase: true

- name: complex-transition-rats
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: complex-pool
      trigger: true
      passed: [ complex-transition-deploy ]
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: github-routing-release-master
      - get: legacy-routing-release
        passed: [ complex-transition-deploy ]
        params:
          tarball: false
      - get: legacy-cf-networking-release
        passed: [ complex-transition-deploy ]
        params:
          tarball: false
      - get: legacy-grootfs-release
        passed: [ complex-transition-deploy ]
        params:
          tarball: false
      - get: dumbledore-env-stubs-and-vars
      - get: cf-deployment-release-candidate
        passed: [ complex-transition-deploy ]
      - get: legacy-cf-release
        passed: [ complex-transition-deploy ]
        params:
          tarball: false
      - get: legacy-diego-release
        passed: [ complex-transition-deploy ]
        params:
          tarball: false
      - get: legacy-cflinuxfs2-release
        passed: [ complex-transition-deploy ]
        params:
          tarball: false
      - get: legacy-garden-runc-release
        passed: [ complex-transition-deploy ]
        params:
          tarball: false
      - get: cf-deployment-transition
        passed: [ complex-transition-deploy ]
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      input_mapping:
        vars-store: dumbledore-env-stubs-and-vars
      params:
        SYSTEM_DOMAIN: dumbledore.cf-app.com
    - task: run-rats
      input_mapping:
        routing-release: github-routing-release-master
        integration-config: dumbledore-env-stubs-and-vars
      file: runtime-ci/scripts/ci/run-rats/task.yml
      params:
        PACKAGES: "http_routes tcp_routing"

- name: complex-transition-delete-deployment
  public: true
  serial: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: complex-pool
      passed: [ complex-transition-cats, complex-transition-rats ]
      trigger: true
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: dumbledore-env-director-state
  - task: delete-deployment-cf
    input_mapping:
      bbl-state: dumbledore-env-director-state
    file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
  - put: complex-pool
    params: {release: complex-pool}

- name: transition-deploy
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: transition-pool
      passed: [ legacy-deploy ]
      trigger: true
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: minerva-env-stubs-and-vars
      - get: minerva-env-director-state
      - get: cf-deployment-release-candidate
        passed: [ bless-manifest ]
      - get: legacy-cf-release
        passed: [ legacy-deploy ]
      - get: legacy-diego-release
        passed: [ legacy-deploy ]
      - get: legacy-cflinuxfs2-release
        passed: [ legacy-deploy ]
      - get: legacy-garden-runc-release
        passed: [ legacy-deploy ]
      - get: cf-deployment-transition
    - task: extract-vars-store
      file: runtime-ci/tasks/r2d2/task.yml
      input_mapping:
        bbl-state: minerva-env-director-state
        vars-store: minerva-env-stubs-and-vars
      params:
        BBL_STATE_DIR: bbl-state
    - task: bosh-upload-stemcell
      file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
      input_mapping:
        cf-deployment: cf-deployment-release-candidate
        bbl-state: minerva-env-director-state
      params:
        BBL_STATE_DIR: bbl-state
        INFRASTRUCTURE: aws
    - task: collect-ops-files
      file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
      input_mapping:
        base-ops-files: cf-deployment-release-candidate
        new-ops-files: cf-deployment-transition
      params:
        BASE_OPS_FILE_DIR: "operations"
        NEW_OPS_FILES: |
          cfr-to-cfd.yml
          enable-doppler-announce.yml
          keep-etcd-for-transition.yml
          remove-routing-components-for-transition.yml
          remove-cf-networking-for-transition.yml
    - task: remove-static-ips-from-cloud-config
      file: runtime-ci/tasks/bosh-extend-cloud-config/task.yml
      input_mapping:
        bbl-state: minerva-env-director-state
        ops-file: minerva-env-stubs-and-vars
      params:
        BBL_STATE_DIR: bbl-state
        OPS_FILE_PATH: add-static-ips-to-dynamic-range.yml
    - task: bosh-deploy-cf
      file: runtime-ci/tasks/transition-deploy/task.yml
      input_mapping:
        bbl-state: minerva-env-director-state
        cf-deployment: cf-deployment-release-candidate
        ops-files: collected-ops-files
        vars-store: extracted-vars-store
        vars-files: minerva-env-stubs-and-vars
      params:
        BBL_STATE_DIR: bbl-state
        SYSTEM_DOMAIN: minerva.cf-app.com
        UPTIMER_APP_DOMAIN: minerva.cf-app.com
        UPTIMER_TCP_DOMAIN: placeholder.this.is.dumb.com
        OPS_FILES: |
          operations/use-compiled-releases.yml
          operations/aws.yml
          operations/keep-etcd-for-transition.yml
          operations/enable-doppler-announce.yml
          operations/use-external-dbs.yml
          operations/use-s3-blobstore.yml
          operations/set-bbs-active-key.yml
          operations/cfr-to-cfd.yml
          operations/remove-routing-components-for-transition.yml
          operations/remove-cf-networking-for-transition.yml
        VARS_FILES: |
          rds-vars.yml
          s3-vars.yml
          static_ips.yml
        DEPLOY_WITH_UPTIME_MEASUREMENTS: true
        FAIL_ON_DOWNTIME: true
      on_failure:
        put: minerva-env-stubs-and-vars
        params:
          repository: updated-vars-store
          rebase: true
    - task: bosh-deploy-cf-without-etcd
      file: runtime-ci/tasks/transition-deploy/task.yml
      input_mapping:
        bbl-state: minerva-env-director-state
        cf-deployment: cf-deployment-release-candidate
        ops-files: collected-ops-files
        vars-store: updated-vars-store
        vars-files: minerva-env-stubs-and-vars
      params:
        BBL_STATE_DIR: bbl-state
        SYSTEM_DOMAIN: minerva.cf-app.com
        UPTIMER_APP_DOMAIN: minerva.cf-app.com
        UPTIMER_TCP_DOMAIN: placeholder.this.is.dumb.com
        OPS_FILES: |
          operations/use-compiled-releases.yml
          operations/aws.yml
          operations/use-external-dbs.yml
          operations/use-s3-blobstore.yml
          operations/set-bbs-active-key.yml
          operations/remove-routing-components-for-transition.yml
          operations/remove-cf-networking-for-transition.yml
        VARS_FILES: |
          rds-vars.yml
          s3-vars.yml
        DEPLOY_WITH_UPTIME_MEASUREMENTS: true
        FAIL_ON_DOWNTIME: true
      ensure:
        put: minerva-env-stubs-and-vars
        params:
          repository: updated-vars-store
          rebase: true
    - task: run-bosh-cleanup
      file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
      input_mapping:
        bbl-state: minerva-env-stubs-and-vars

- name: fresh-deploy
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - get: fresh-pool
    trigger: true
    passed: [ fresh-acquire-pool ]
  - aggregate:
    - get: cf-deployment-develop
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: luna-env-vars-store
    - get: luna-env-integration-configs
    - get: luna-env-director-state
  - task: guarantee-no-existing-cf-deployment
    file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
    input_mapping:
      bbl-state: luna-env-director-state
    params:
      DEPLOYMENT_NAME: luna-cf
      BBL_STATE_DIR: bbl-state
  - task: bosh-upload-stemcell-fresh
    file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
    input_mapping:
      cf-deployment: cf-deployment-develop
      bbl-state: luna-env-director-state
    params:
      INFRASTRUCTURE: google
      BBL_STATE_DIR: bbl-state
  - task: bosh-deploy-cf
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    input_mapping:
      bbl-state: luna-env-director-state
      cf-deployment: cf-deployment-develop
      ops-files: cf-deployment-develop
      vars-store: luna-env-vars-store
      vars-files: luna-env-vars-store
    params:
      BBL_STATE_DIR: bbl-state
      SYSTEM_DOMAIN: luna.cf-app.com
      OPS_FILES: |
        operations/use-compiled-releases.yml
        operations/rename-network.yml
        operations/rename-deployment.yml
        operations/set-bbs-active-key.yml
        operations/test/add-persistent-isolation-segment-diego-cell.yml
        operations/test/add-persistent-isolation-segment-router.yml
        operations/addons/enable-component-syslog.yml
        operations/use-gcs-blobstore.yml
        operations/workaround/use-4-azs-for-router.yml
      VARS_FILES: |
        deployment-name.yml
        network-name.yml
        bbs-key-label.yml
        syslog-vars.yml
        gcs-vars.yml
      REGENERATE_VARS_STORE: true
    ensure:
      put: luna-env-vars-store
      params:
        repository: updated-vars-store
        rebase: true
  - task: run-bosh-cleanup
    file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
    input_mapping:
      bbl-state: luna-env-director-state
    params:
      BBL_STATE_DIR: bbl-state
  - task: update-integration-configs
    file: cf-deployment-concourse-tasks/update-integration-configs/task.yml
    params:
      CATS_INTEGRATION_CONFIG_FILE: integration_config.json
    input_mapping:
      vars-store: luna-env-vars-store
      integration-configs: luna-env-integration-configs
    ensure:
      put: luna-env-integration-configs
      params:
        repository: updated-integration-configs
        rebase: true
  - task: ensure-gcloud-backend-service-healthy
    file: runtime-ci/tasks/ensure-gcloud-backend-service-healthy/task.yml
    input_mapping:
      google-creds-dir: luna-env-director-state
    params:
      GCP_PROJECT_ID: {{luna_gcp_project}}
      GCP_BACKEND_SERVICE: {{luna_router_backend_service}}
  - task: ensure-api-healthy
    file: runtime-ci/scripts/ci/wait-for-endpoint/task.yml
    params:
      ENDPOINT: api.luna.cf-app.com
      DD_API_KEY: {{datadog_api_key}}
      METRIC_NAME: time-to-healthy-router
      ENV_NAME: luna

- name: ops-test
  serial_groups: [trelawney]
  public: true
  build_logs_to_retain: 100
  plan:
  - ensure:
      put: ops-pool
      params: {release: ops-pool}
    do:
    - get: ops-pool
      trigger: true
      passed: [ ops-acquire-pool ]
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: cf-deployment-develop
      - get: trelawney-env-director-state
    - task: bosh-upload-stemcell-ops
      file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
      input_mapping:
        cf-deployment: cf-deployment-develop
        bbl-state: trelawney-env-director-state
      params:
        BBL_STATE_DIR: bbl-state
        INFRASTRUCTURE: google
    - task: bosh-dry-run-with-ops-cf-internal-mysql
      file: runtime-ci/tasks/bosh-dry-run-with-ops/task.yml
      input_mapping:
        bbl-state: trelawney-env-director-state
        cf-deployment: cf-deployment-develop
        ops-files: cf-deployment-develop
        vars-files: cf-deployment-develop
      params:
        BBL_STATE_DIR: bbl-state
        SYSTEM_DOMAIN: trelawney.cf-app.com
        OPS_FILES: "operations/scale-to-one-az.yml operations/experimental/skip-consul-locks.yml operations/experimental/use-grootfs.yml operations/experimental/use-bosh-dns.yml operations/experimental/use-bosh-dns-for-containers.yml"
        DEPLOYMENT_NAME_SUFFIX: internal-mysql
    - task: bosh-dry-run-with-ops-cf-internal-postgres
      file: runtime-ci/tasks/bosh-dry-run-with-ops/task.yml
      input_mapping:
        bbl-state: trelawney-env-director-state
        cf-deployment: cf-deployment-develop
        ops-files: cf-deployment-develop
        vars-files: cf-deployment-develop
      params:
        BBL_STATE_DIR: bbl-state
        SYSTEM_DOMAIN: trelawney.cf-app.com
        OPS_FILES: "operations/use-postgres.yml operations/experimental/enable-prefer-declarative-healthchecks.yml"
        DEPLOYMENT_NAME_SUFFIX: internal-postgres
    - task: bosh-dry-run-with-ops-cf-external-persistence
      file: runtime-ci/tasks/bosh-dry-run-with-ops/task.yml
      input_mapping:
        bbl-state: trelawney-env-director-state
        cf-deployment: cf-deployment-develop
        ops-files: cf-deployment-develop
        vars-files: cf-deployment-develop
      params:
        BBL_STATE_DIR: bbl-state
        SYSTEM_DOMAIN: trelawney.cf-app.com
        OPS_FILES: "operations/scale-to-one-az.yml operations/experimental/skip-consul-locks.yml operations/experimental/use-grootfs.yml operations/use-s3-blobstore.yml operations/use-external-dbs.yml operations/experimental/enable-iptables-logger.yml"
        VARS_FILES: "operations/example-vars-files/vars-use-s3-blobstore.yml operations/example-vars-files/vars-use-external-dbs.yml"
        DEPLOYMENT_NAME_SUFFIX: external-persistence

- name: upgrade-acquire-pool
  public: true
  serial: true
  plan:
  - aggregate:
    - get: cf-deployment-develop
      trigger: true
      passed: [unit-test-ops-files, unit-test-update-releases-coverage]
    - put: upgrade-pool
      params: {acquire: true}

- name: upgrade-release-pool
  public: true
  plan:
  - get: upgrade-pool
    passed: [ upgrade-rats, upgrade-cats, upgrade-wats, upgrade-smoke-tests ]
    trigger: true
  - put: upgrade-pool
    params: {release: upgrade-pool}

- name: stable-acquire-pool
  public: true
  serial: true
  plan:
  - aggregate:
    - get: cf-deployment-master
      trigger: true
    - put: stable-pool
      params: {acquire: true}

- name: lite-release-pool
  public: true
  plan:
  - get: lite-pool
    passed: [ lite-cats, lite-rats ]
    trigger: true
  - put: lite-pool
    params: {release: lite-pool}

- name: fresh-release-pool-manual
  public: true
  plan:
  - get: fresh-pool
  ensure:
    try:
      put: fresh-pool
      params: {release: fresh-pool}

- name: lite-release-pool-manual
  public: true
  plan:
  - get: lite-pool
  ensure:
    try:
      put: lite-pool
      params: {release: lite-pool}

- name: transition-release-pool-manual
  public: true
  plan:
  - get: transition-pool
  ensure:
    try:
      put: transition-pool
      params: {release: transition-pool}

- name: complex-release-pool-manual
  public: true
  plan:
  - get: complex-pool
  ensure:
    try:
      put: complex-pool
      params: {release: complex-pool}

- name: stable-release-pool-manual
  public: true
  plan:
  - get: stable-pool
  ensure:
    try:
      put: stable-pool
      params: {release: stable-pool}

- name: upgrade-deploy
  serial_groups: [ hermione-wats, hermione-cats, hermione-smokes, hermione-rats ]
  public: true
  build_logs_to_retain: 100
  plan:
  - on_failure:
      put: upgrade-pool
      params: {release: upgrade-pool}
    do:
    - get: upgrade-pool
      trigger: true
      passed: [ upgrade-acquire-pool ]
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: cf-deployment-develop
      - get: hermione-env-vars-store
      - get: hermione-env-turbulence-manifest
      - get: hermione-env-turbulence-vars
      - get: hermione-env-director-state
      - get: hermione-env-integration-configs
      - get: windows-stemcell-bosh-release
    - task: bosh-upload-stemcell-upgrade
      file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
      input_mapping:
        cf-deployment: cf-deployment-develop
        bbl-state: hermione-env-director-state
      params:
        INFRASTRUCTURE: aws
        BBL_STATE_DIR: bbl-state
    - task: bosh-upload-windows-stemcell
      file: runtime-ci/scripts/ci/bosh-upload-stemcell/task.yml
      input_mapping:
        stemcell: windows-stemcell-bosh-release
        bbl-state: hermione-env-director-state
      params:
        STEMCELL_NAME: '*.tgz'
        BBL_STATE_DIR: bbl-state
    - task: bosh-update-runtime-config
      file: runtime-ci/tasks/bosh-update-runtime-config/task.yml
      input_mapping:
        bbl-state: hermione-env-director-state
        runtime-configs: hermione-env-vars-store
        vars-files: hermione-env-vars-store
      params:
        RUNTIME_CONFIG_FILE: runtime-config.yml
        BBL_STATE_DIR: bbl-state
    - task: deploy-turbulence-api-upgrade
      file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
      input_mapping:
        cf-deployment: hermione-env-turbulence-manifest
        vars-store: hermione-env-turbulence-vars
        bbl-state: hermione-env-director-state
        ops-files: runtime-ci
        vars-files: hermione-env-turbulence-vars
      params:
        BBL_STATE_DIR: bbl-state
        MANIFEST_FILE: turbulence.yml
        SYSTEM_DOMAIN: cf-app.com # not used, this is a required by the task
        VARS_STORE_FILE: turbulence-deployment-vars.yml
        OPS_FILES: "experiments/operations/add-turbulence-bosh-io-release.yml experiments/operations/add-bosh-dns-bosh-io-release.yml"
      ensure:
        put: hermione-env-turbulence-vars
        params:
          repository: updated-vars-store
          rebase: true
    - task: collect-ops-files
      file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
      input_mapping:
        base-ops-files: cf-deployment-develop
        new-ops-files: hermione-env-vars-store
      params:
        BASE_OPS_FILE_DIR: "operations"
        NEW_OPS_FILES: "scale-windows-cells.yml"
    - task: bosh-deploy-cf
      file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
      input_mapping:
        bbl-state: hermione-env-director-state
        cf-deployment: cf-deployment-develop
        ops-files: collected-ops-files
        vars-store: hermione-env-vars-store
        vars-files: hermione-env-vars-store
      params:
        BBL_STATE_DIR: bbl-state
        SYSTEM_DOMAIN: hermione.cf-app.com
        OPS_FILES: |
          operations/aws.yml
          operations/windows-cell.yml
          operations/scale-windows-cells.yml
          operations/test/disable_windows_consul_agent_nameserver_overwriting.yml
          operations/test/add-datadog-firehose-nozzle.yml
          operations/use-s3-blobstore.yml
          operations/experimental/enable-instance-identity-credentials.yml
          operations/experimental/secure-service-credentials.yml
          operations/use-external-dbs.yml
          operations/experimental/secure-service-credentials-external-db.yml
          operations/enable-privileged-container-support.yml
          operations/experimental/use-bosh-dns.yml
          operations/experimental/use-bosh-dns-for-containers.yml
          operations/stop-skipping-tls-validation.yml
          operations/configure-confab-timeout.yml
        VARS_FILES: "datadog-deployment-vars.yml rds-vars.yml confab-timeout-vars.yml"
        DEPLOY_WITH_UPTIME_MEASUREMENTS: true
      ensure:
        put: hermione-env-vars-store
        params:
          repository: updated-vars-store
          rebase: true
    - task: run-bosh-cleanup
      file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
      input_mapping:
        bbl-state: hermione-env-director-state
      params:
        BBL_STATE_DIR: bbl-state
    - task: update-integration-configs
      file: cf-deployment-concourse-tasks/update-integration-configs/task.yml
      params:
        CATS_INTEGRATION_CONFIG_FILE: integration_config.json
      input_mapping:
        vars-store: hermione-env-vars-store
        integration-configs: hermione-env-integration-configs
      ensure:
        put: hermione-env-integration-configs
        params:
          repository: updated-integration-configs
          rebase: true

- name: stable-deploy
  serial_groups: [ bellatrix-smokes ]
  public: true
  build_logs_to_retain: 100
  plan:
  - on_failure:
      put: stable-pool
      params: {release: stable-pool}
    do:
    - get: stable-pool
      trigger: true
      passed: [ stable-acquire-pool ]
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: cf-deployment-master
      - get: bellatrix-env-vars-store
      - get: bellatrix-env-director-state
      - get: bellatrix-env-integration-configs
      - get: windows-google-stemcell
    - task: bosh-upload-stemcell-stable
      file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
      input_mapping:
        cf-deployment: cf-deployment-master
        bbl-state: bellatrix-env-director-state
      params:
        BBL_STATE_DIR: bbl-state
        INFRASTRUCTURE: google
    - task: bosh-upload-windows-stemcell
      file: runtime-ci/scripts/ci/bosh-upload-stemcell/task.yml
      input_mapping:
        stemcell: windows-google-stemcell
        bbl-state: bellatrix-env-director-state
      params:
        BBL_STATE_DIR: bbl-state
        STEMCELL_NAME: '*.tgz'
    - task: bosh-deploy-cf
      file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
      input_mapping:
        bbl-state: bellatrix-env-director-state
        cf-deployment: cf-deployment-master
        ops-files: cf-deployment-master
        vars-store: bellatrix-env-vars-store
        vars-files: bellatrix-env-vars-store
      params:
        BBL_STATE_DIR: bbl-state
        SYSTEM_DOMAIN: bellatrix.cf-app.com
        OPS_FILES: "operations/scale-database-cluster.yml"
      ensure:
        put: bellatrix-env-vars-store
        params:
          repository: updated-vars-store
          rebase: true
    - task: run-bosh-cleanup
      file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
      input_mapping:
        bbl-state: bellatrix-env-director-state
      params:
        BBL_STATE_DIR: bbl-state
    - task: update-integration-configs
      file: cf-deployment-concourse-tasks/update-integration-configs/task.yml
      params:
        CATS_INTEGRATION_CONFIG_FILE: integration_config.json
      input_mapping:
        vars-store: bellatrix-env-vars-store
        integration-configs: bellatrix-env-integration-configs
      ensure:
        put: bellatrix-env-integration-configs
        params:
          repository: updated-integration-configs
          rebase: true

- name: lite-deploy
  public: true
  serial_groups: [ snitch-cats, snitch-rats ]
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: lite-pool
      trigger: true
      passed: [ lite-acquire-pool ]
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: cf-deployment-develop
      - get: bosh-deployment
      - get: snitch-env-director-state
      - get: snitch-env-vars-store
      - get: snitch-env-integration-configs
    - task: guarantee-no-existing-cf-deployment
      file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
      input_mapping:
        bbl-state: snitch-env-director-state
      params:
        BBL_STATE_DIR: bbl-state
    - task: bosh-update-cloud-config
      file: runtime-ci/scripts/ci/bosh-update-cloud-config/task.yml
      input_mapping:
        bbl-state: snitch-env-director-state
        cloud-config: cf-deployment-develop
      params:
        BBL_STATE_DIR: bbl-state
        CLOUD_CONFIG_FILE: "iaas-support/bosh-lite/cloud-config.yml"
    - task: bosh-upload-stemcell-lite
      file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
      input_mapping:
        cf-deployment: cf-deployment-develop
        bbl-state: snitch-env-director-state
      params:
        BBL_STATE_DIR: bbl-state
        INFRASTRUCTURE: bosh-lite
    - task: bosh-deploy-cf-deployment
      file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
      input_mapping:
        bbl-state: snitch-env-director-state
        cf-deployment: cf-deployment-develop
        vars-store: snitch-env-vars-store
        ops-files: cf-deployment-develop
        vars-files: snitch-env-vars-store
      params:
        BBL_STATE_DIR: bbl-state
        SYSTEM_DOMAIN: snitch.cf-app.com
        OPS_FILES: "operations/use-compiled-releases.yml operations/bosh-lite.yml operations/use-postgres.yml"
      ensure:
        put: snitch-env-vars-store
        params:
          repository: updated-vars-store
          rebase: true
    - task: run-bosh-cleanup
      file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
      input_mapping:
        bbl-state: snitch-env-director-state
      params:
        BBL_STATE_DIR: bbl-state
    - task: update-integration-configs
      file: cf-deployment-concourse-tasks/update-integration-configs/task.yml
      params:
        CATS_INTEGRATION_CONFIG_FILE: integration_config.json
      input_mapping:
        vars-store: snitch-env-vars-store
        integration-configs: snitch-env-integration-configs
      ensure:
        put: snitch-env-integration-configs
        params:
          repository: updated-integration-configs
          rebase: true
    - task: ensure-api-healthy
      file: runtime-ci/scripts/ci/wait-for-endpoint/task.yml
      params:
        ENDPOINT: api.snitch.cf-app.com
        DD_API_KEY: {{datadog_api_key}}
        METRIC_NAME: time-to-healthy-router
        ENV_NAME: snitch

- name: complex-transition-cats
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: complex-pool
      passed: [ complex-transition-deploy ]
      trigger: true
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: cf-acceptance-tests
      - get: dumbledore-env-stubs-and-vars
      - get: cf-deployment-release-candidate
        passed: [ complex-transition-deploy ]
      - get: cats-concourse-task
      - get: legacy-cf-release
        passed: [ complex-transition-deploy ]
      - get: legacy-diego-release
        passed: [ complex-transition-deploy ]
      - get: legacy-cflinuxfs2-release
        passed: [ complex-transition-deploy ]
      - get: legacy-garden-runc-release
        passed: [ complex-transition-deploy ]
      - get: legacy-routing-release
        passed: [ complex-transition-deploy ]
        params:
          tarball: false
      - get: legacy-cf-networking-release
        passed: [ complex-transition-deploy ]
        params:
          tarball: false
      - get: legacy-grootfs-release
        passed: [ complex-transition-deploy ]
        params:
          tarball: false
      - get: cf-deployment-transition
        passed: [ complex-transition-deploy ]
        trigger: true
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      input_mapping:
        vars-store: dumbledore-env-stubs-and-vars
      params:
        SYSTEM_DOMAIN: dumbledore.cf-app.com
    - task: run-cats
      input_mapping:
        integration-config: dumbledore-env-stubs-and-vars
      params:
        NODES: 9
      file: cats-concourse-task/task.yml

- name: transition-cats
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: transition-pool
      passed: [ transition-deploy ]
      trigger: true
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: cf-acceptance-tests
      - get: minerva-env-stubs-and-vars
      - get: cf-deployment-release-candidate
        passed: [ transition-deploy ]
      - get: cats-concourse-task
      - get: legacy-cf-release
        passed: [ transition-deploy ]
      - get: legacy-diego-release
        passed: [ transition-deploy ]
      - get: legacy-cflinuxfs2-release
        passed: [ transition-deploy ]
      - get: legacy-garden-runc-release
        passed: [ transition-deploy ]
      - get: cf-deployment-transition
        passed: [ transition-deploy ]
        trigger: true
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      input_mapping:
        vars-store: minerva-env-stubs-and-vars
      params:
        SYSTEM_DOMAIN: minerva.cf-app.com
    - task: run-cats
      input_mapping:
        integration-config: minerva-env-stubs-and-vars
      params:
        NODES: 9
      file: cats-concourse-task/task.yml

- name: transition-record-compatible-versions
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - aggregate:
      - get: runtime-ci
      - get: legacy-cf-release
        passed: [ transition-cats, complex-transition-cats, complex-transition-rats ]
        params:
          tarball: false
      - get: legacy-diego-release
        passed: [ transition-cats, complex-transition-cats, complex-transition-rats ]
        trigger: true
        params:
          tarball: false
      - get: legacy-cflinuxfs2-release
        passed: [ transition-cats, complex-transition-cats, complex-transition-rats ]
        trigger: true
        params:
          tarball: false
      - get: legacy-garden-runc-release
        passed: [ transition-cats, complex-transition-cats, complex-transition-rats ]
        trigger: true
        params:
          tarball: false
      - get: legacy-routing-release
        passed: [ complex-transition-cats, complex-transition-rats ]
        params:
          tarball: false
      - get: legacy-cf-networking-release
        passed: [ complex-transition-cats, complex-transition-rats ]
        params:
          tarball: false
      - get: legacy-grootfs-release
        passed: [ complex-transition-cats, complex-transition-rats ]
        params:
          tarball: false
      - get: cf-deployment-release-candidate
        passed: [ transition-cats, complex-transition-cats, complex-transition-rats ]
        trigger: true
      - get: cf-deployment-transition
        passed: [ transition-cats, complex-transition-cats, complex-transition-rats ]
        trigger: true
      - get: cf-deployment-transition-compatibility
    - task: record-compatible-versions
      file: runtime-ci/tasks/record-r2d2-compatible-versions/task.yml
      input_mapping:
        cf-release: legacy-cf-release
        diego-release: legacy-diego-release
        cflinuxfs2-release: legacy-cflinuxfs2-release
        garden-runc-release: legacy-garden-runc-release
        routing-release: legacy-routing-release
        cf-networking-release: legacy-cf-networking-release
        grootfs-release: legacy-grootfs-release
        cf-deployment: cf-deployment-release-candidate
    - put: cf-deployment-transition-compatibility
      params:
        repository: updated-r2d2-compatibility
        rebase: true

- name: transition-delete-deployment
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: transition-pool
      passed: [ transition-cats ]
      trigger: true
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: minerva-env-director-state
  - task: delete-deployment-cf
    file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
    input_mapping:
      bbl-state: minerva-env-director-state
    params:
      BBL_STATE_DIR: bbl-state
  - put: transition-pool
    params: {release: transition-pool}

- name: upgrade-cats
  serial_groups: [ hermione-cats ]
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    on_failure:
      put: upgrade-pool
      params: {release: upgrade-pool}
    do:
    - get: upgrade-pool
      trigger: true
      passed: [ upgrade-deploy ]
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: cf-acceptance-tests
      - get: hermione-env-director-state
        passed: [ upgrade-deploy ]
      - get: hermione-env-integration-configs
      - get: hermione-env-vars-store
        passed: [ upgrade-deploy ]
      - get: cf-deployment-develop
        passed: [ upgrade-deploy ]
      - get: cats-concourse-task
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      input_mapping:
        vars-store: hermione-env-vars-store
      params:
        SYSTEM_DOMAIN: hermione.cf-app.com
    - task: run-cats
      input_mapping:
        integration-config: hermione-env-integration-configs
      file: cats-concourse-task/task.yml

- name: upgrade-wats
  public: true
  serial_groups: [ hermione-wats ]
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    on_failure:
      put: upgrade-pool
      params: {release: upgrade-pool}
    do:
    - get: upgrade-pool
      trigger: true
      passed: [ upgrade-deploy ]
    - aggregate:
      - get: runtime-ci
      - get: windows-acceptance-tests
      - get: hermione-env-integration-configs
      - get: hermione-env-director-state
        passed: [ upgrade-deploy ]
      - get: hermione-env-vars-store
        passed: [ upgrade-deploy ]
      - get: cf-deployment-develop
        passed: [ upgrade-deploy ]
    - task: run-wats
      input_mapping:
        integration-config: hermione-env-integration-configs
      file: runtime-ci/tasks/run-wats/task.yml

- name: upgrade-smoke-tests
  serial_groups: [hermione-smokes]
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 1h
    on_failure:
      put: upgrade-pool
      params: {release: upgrade-pool}
    do:
    - get: upgrade-pool
      trigger: true
      passed: [upgrade-deploy]
    - aggregate:
      - get: runtime-ci
      - get: hermione-env-director-state
        passed: [upgrade-deploy]
      - get: cf-deployment-develop
        passed: [upgrade-deploy]
  - task: bosh-run-errand-smoke-tests
    file: runtime-ci/tasks/run-errand/task.yml
    input_mapping:
      bbl-state: hermione-env-director-state
    params:
      BBL_STATE_DIR: bbl-state
      ERRAND_NAME: smoke-tests

- name: stable-smoke-tests
  serial_groups: [bellatrix-smokes]
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 1h
    ensure:
      put: stable-pool
      params: {release: stable-pool}
    do:
    - get: stable-pool
      trigger: true
      passed: [stable-deploy]
    - aggregate:
      - get: runtime-ci
      - get: bellatrix-env-director-state
        passed: [stable-deploy]
      - get: cf-deployment-master
        passed: [stable-deploy]
  - task: bosh-run-errand-smoke-tests
    file: runtime-ci/tasks/run-errand/task.yml
    input_mapping:
      bbl-state: bellatrix-env-director-state
    params:
      BBL_STATE_DIR: bbl-state
      ERRAND_NAME: smoke-tests

- name: stable-semihourly-pool-acquisition
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: half-hourly
      trigger: true
    - put: stable-pool
      params: {claim: bellatrix}

- name: stable-periodic-cats
  serial: true
  public: true
  build_logs_to_retain: 2000
  plan:
  - timeout: 4h
    on_failure:
      put: stable-pool
      params: {release: stable-pool}
    do:
    - get: stable-pool
      trigger: true
      passed: [ stable-semihourly-pool-acquisition ]
    - aggregate:
      - get: cats-concourse-task
      - get: cf-deployment-concourse-tasks
      - get: cf-acceptance-tests
      - get: bellatrix-env-vars-store
      - get: bellatrix-env-integration-configs
      - get: cf-deployment-master
        passed: [ stable-deploy ]
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      input_mapping:
        vars-store: bellatrix-env-vars-store
      params:
        SYSTEM_DOMAIN: bellatrix.cf-app.com
    - task: run-cats
      input_mapping:
        integration-config: bellatrix-env-integration-configs
      file: cats-concourse-task/task.yml

- name: stable-update-cats-cfd-branch
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    ensure:
      put: stable-pool
      params: {release: stable-pool}
    do:
    - get: stable-pool
      trigger: true
      passed: [ stable-periodic-cats ]
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-master
        passed: [ stable-periodic-cats ]
      - get: cf-acceptance-tests
        passed: [ stable-periodic-cats ]
    - task: update-branch
      file: runtime-ci/tasks/update-cats-branch-with-cf-deployment-version/task.yml
      input_mapping:
        cf-deployment: cf-deployment-master
      params:
        DEPLOY_KEY: {{cf_acceptance_tests_private_key}}

- name: fresh-cats
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: fresh-pool
      trigger: true
      passed: [ fresh-deploy ]
    - aggregate:
      - get: cats-concourse-task
      - get: cf-deployment-concourse-tasks
      - get: cf-acceptance-tests
      - get: luna-env-vars-store
      - get: luna-env-integration-configs
      - get: cf-deployment-develop
        passed: [ fresh-deploy ]
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      input_mapping:
        vars-store: luna-env-vars-store
      params:
        SYSTEM_DOMAIN: luna.cf-app.com
    - task: run-cats
      input_mapping:
        integration-config: luna-env-integration-configs
      params:
        CAPTURE_LOGS: true
      file: cats-concourse-task/task.yml

- name: lite-cats
  serial_groups: [ snitch-cats ]
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: lite-pool
      trigger: true
      passed: [ lite-deploy ]
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: cf-acceptance-tests
      - get: cf-deployment-develop
        passed: [ lite-deploy ]
      - get: snitch-env-director-state
        passed: [ lite-deploy ]
      - get: snitch-env-vars-store
        passed: [ lite-deploy ]
      - get: snitch-env-integration-configs
      - get: cats-concourse-task
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      attempts: 10
      input_mapping:
        vars-store: snitch-env-vars-store
      params:
        SYSTEM_DOMAIN: snitch.cf-app.com
    - task: run-cats
      input_mapping:
        integration-config: snitch-env-integration-configs
      params:
        NODES: 4
      file: cats-concourse-task/task.yml

- name: fresh-rats
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: fresh-pool
      trigger: true
      passed: [ fresh-deploy ]
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: github-routing-release-master
      - get: luna-env-vars-store
      - get: luna-env-integration-configs
      - get: cf-deployment-develop
        passed: [ fresh-deploy ]
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      input_mapping:
        vars-store: luna-env-vars-store
      params:
        SYSTEM_DOMAIN: luna.cf-app.com
    - task: run-rats
      input_mapping:
        routing-release: github-routing-release-master
        integration-config: luna-env-integration-configs
      file: runtime-ci/scripts/ci/run-rats/task.yml

- name: lite-rats
  serial_groups: [ snitch-rats ]
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: lite-pool
      trigger: true
      passed: [ lite-deploy ]
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: github-routing-release-master
      - get: snitch-env-integration-configs
      - get: snitch-env-director-state
        passed: [ lite-deploy ]
      - get: snitch-env-vars-store
        passed: [ lite-deploy ]
      - get: cf-deployment-develop
        passed: [ lite-deploy ]
    - task: enable-docker-and-tasks
      attempts: 10
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      input_mapping:
        vars-store: snitch-env-vars-store
      params:
        SYSTEM_DOMAIN: snitch.cf-app.com
    - task: run-rats
      input_mapping:
        routing-release: github-routing-release-master
        integration-config: snitch-env-integration-configs
      file: runtime-ci/scripts/ci/run-rats/task.yml

- name: upgrade-rats
  serial_groups: [ hermione-rats ]
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    on_failure:
      put: upgrade-pool
      params: {release: upgrade-pool}
    do:
    - get: upgrade-pool
      trigger: true
      passed: [upgrade-deploy]
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: github-routing-release-master
      - get: hermione-env-integration-configs
      - get: hermione-env-director-state
        passed: [ upgrade-deploy ]
      - get: hermione-env-vars-store
        passed: [ upgrade-deploy ]
      - get: cf-deployment-develop
        passed: [ upgrade-deploy ]
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      input_mapping:
        vars-store: hermione-env-vars-store
      params:
        SYSTEM_DOMAIN: hermione.cf-app.com
    - task: run-rats
      input_mapping:
        routing-release: github-routing-release-master
        integration-config: hermione-env-integration-configs
      file: runtime-ci/scripts/ci/run-rats/task.yml

- name: fresh-delete-deployment
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: fresh-pool
      trigger: true
      passed:
      - fresh-cats
      - fresh-rats
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: luna-env-director-state
    - task: delete-deployment-cf
      input_mapping:
        bbl-state: luna-env-director-state
      file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
      params:
        BBL_STATE_DIR: bbl-state
        DEPLOYMENT_NAME: luna-cf
    - put: fresh-pool
      params: {release: fresh-pool}

- name: bless-manifest
  public: true
  serial: true
  build_logs_to_retain: 100
  plan:
  - get: cf-deployment-develop
    trigger: true
    passed:
    - fresh-cats
    - lite-cats
    - upgrade-cats
    - lite-rats
    - upgrade-rats
    - fresh-rats
    - upgrade-smoke-tests
    - ops-test
  - put: cf-deployment-release-candidate
    params:
      repository: cf-deployment-develop
  - put: deliver-tracker-story
    params:
      repos:
        - cf-deployment-develop

- name: release-notes-template
  public: true
  build_logs_to_retain: 100
  plan:
  - aggregate:
    - get: runtime-ci
    - get: cf-deployment-master
    - get: cf-deployment-release-candidate
      passed:
      - bless-manifest
      trigger: true
  - task: generate-cf-deployment-release-notes-template
    file: runtime-ci/tasks/cf-deployment-release-notes-template/task.yml

- name: ship-it-patch
  public: true
  build_logs_to_retain: 100
  plan:
    - do:
      - get: runtime-ci
      - put: cf-deployment-version
        params: { bump: patch }
      - get: cf-deployment-release-candidate
        passed: [transition-record-compatible-versions]
      - get: cf-deployment-transition-compatibility
      - put: cf-deployment-master
        params:
          repository: cf-deployment-release-candidate
          tag: cf-deployment-version/version
          tag_prefix: v
      - task: record-transition-version
        file: runtime-ci/tasks/record-transition-version/task.yml
      - put: cf-deployment-transition-compatibility
        params:
          repository: updated-cf-deployment-transition-compatibility
          rebase: true

- name: ship-it-patch-expedited
  public: true
  build_logs_to_retain: 100
  plan:
    - do:
      - get: runtime-ci
      - put: cf-deployment-version
        params: { bump: patch }
      - get: cf-deployment-release-candidate
        passed: [bless-manifest]
      - get: cf-deployment-transition-compatibility
      - put: cf-deployment-master
        params:
          repository: cf-deployment-release-candidate
          tag: cf-deployment-version/version
          tag_prefix: v

- name: ship-it-minor
  public: true
  build_logs_to_retain: 100
  plan:
    - do:
      - get: runtime-ci
      - put: cf-deployment-version
        params: { bump: minor }
      - get: cf-deployment-release-candidate
        passed: [transition-record-compatible-versions]
      - get: cf-deployment-transition-compatibility
      - put: cf-deployment-master
        params:
          repository: cf-deployment-release-candidate
          tag: cf-deployment-version/version
          tag_prefix: v
      - task: record-transition-version
        file: runtime-ci/tasks/record-transition-version/task.yml
      - put: cf-deployment-transition-compatibility
        params:
          repository: updated-cf-deployment-transition-compatibility
          rebase: true

- name: ship-it-minor-expedited
  public: true
  build_logs_to_retain: 100
  plan:
    - do:
      - get: runtime-ci
      - put: cf-deployment-version
        params: { bump: minor }
      - get: cf-deployment-release-candidate
        passed: [bless-manifest]
      - get: cf-deployment-transition-compatibility
      - put: cf-deployment-master
        params:
          repository: cf-deployment-release-candidate
          tag: cf-deployment-version/version
          tag_prefix: v

- name: ship-it-major
  public: true
  build_logs_to_retain: 100
  plan:
    - do:
      - get: runtime-ci
      - put: cf-deployment-version
        params: { bump: major }
      - get: cf-deployment-release-candidate
        passed: [transition-record-compatible-versions]
      - get: cf-deployment-transition-compatibility
      - put: cf-deployment-master
        params:
          repository: cf-deployment-release-candidate
          tag: cf-deployment-version/version
          tag_prefix: v
      - task: record-transition-version
        file: runtime-ci/tasks/record-transition-version/task.yml
      - put: cf-deployment-transition-compatibility
        params:
          repository: updated-cf-deployment-transition-compatibility
          rebase: true

- name: ship-it-major-expedited
  public: true
  build_logs_to_retain: 100
  plan:
    - do:
      - get: runtime-ci
      - put: cf-deployment-version
        params: { bump: major }
      - get: cf-deployment-release-candidate
        passed: [bless-manifest]
      - get: cf-deployment-transition-compatibility
      - put: cf-deployment-master
        params:
          repository: cf-deployment-release-candidate
          tag: cf-deployment-version/version
          tag_prefix: v
