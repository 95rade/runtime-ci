---
groups:
- name: cf-deployment
  jobs:
  - update-releases
  - deploy-releases-fresh
  - deploy-releases-lite
  - deploy-releases-upgrade
  - acceptance-tests-fresh
  - acceptance-tests-lite
  - acceptance-tests-upgrade
  - routing-acceptance-tests-fresh
  - post-delete-deployment-fresh
  - bless-manifest
- name: infrastructure
  jobs:
  - setup-infrastructure-upgrade
  - setup-infrastructure-fresh
  - setup-infrastructure-lite
  - destroy-infrastructure-upgrade
  - destroy-infrastructure-fresh
  - destroy-infrastructure-lite
  - verify-nameserver-has-record
  - run-bosh-cleanup-upgrade
  - run-bosh-cleanup-lite

resource_types:
- name: terraform
  type: docker-image
  source:
    repository: ljfranklin/terraform-resource

resources:
- name: snitch-terraform
  type: terraform
  source:
    storage:
      bucket: runtimeci-tfstate
      bucket_path: cf-deployment-bosh-lite/
      region_name: us-west-1
      access_key_id: {{snitch_terraform_s3_access_key_id}}
      secret_access_key: {{snitch_terraform_s3_secret_key}}
    terraform_source: github.com/cloudfoundry/runtime-ci//tasks/bosh-create-env/terraform/bosh-lite/
    vars:
      project: {{snitch_gcp_project}}
      region: us-central1
      zones: [us-central1-a]
      env_name: snitch
      dns_suffix: cf-app.com
      service_account_key: {{snitch_gcp_service_account_json}}
- name: luna-env-director-state
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/luna-env.git
    private_key: {{luna_env_readwrite_deploy_key}}
    paths:
    - bbl-state.json
    - google_account_creds.json
- name: luna-env-integration-configs
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/luna-env.git
    private_key: {{luna_env_readwrite_deploy_key}}
    paths:
    - integration_config.json
    - rats_integration_config.json
- name: luna-env-vars-store
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/luna-env.git
    private_key: {{luna_env_readwrite_deploy_key}}
    paths:
    - deployment-vars.yml
- name: greengrass-env-director-state
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/greengrass-env.git
    private_key: {{greengrass_env_deploy_key}}
    paths:
    - bbl-state.json
    - google_account_creds.json
- name: weekly
  type: time
  source:
    start: 3:00 -0700
    stop: 3:30 -0700
    interval: 168h
- name: daily
  type: time
  source:
    start: 3:00 -0700
    stop: 3:30 -0700
    interval: 24h
- name: cf-deployment-concourse-tasks
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks.git
- name: runtime-ci
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/runtime-ci.git
- name: hermione-env-director-state
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/hermione-env.git
    private_key: {{hermione_env_private_key}}
    paths:
    - bbl-state.json
- name: hermione-env-integration-configs
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/hermione-env.git
    private_key: {{hermione_env_private_key}}
    paths:
    - integration_config.json
- name: hermione-env-vars-store
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/hermione-env.git
    private_key: {{hermione_env_private_key}}
    paths:
    - deployment-vars.yml
- name: windows-stemcell
  type: s3
  source:
    bucket: bosh-windows-stemcells
    regexp: light-bosh-stemcell-(.*)-aws-xen-hvm-windows2012R2-go_agent.tgz
- name: cf-deployment-develop
  type: git
  source:
    branch: develop
    uri: git@github.com:cloudfoundry/cf-deployment.git
    private_key: {{cf_deployment_private_key}}
- name: cf-deployment-release-candidate
  type: git
  source:
    branch: release-candidate
    uri: git@github.com:cloudfoundry/cf-deployment.git
    private_key: {{cf_deployment_private_key}}
- name: routing-acceptance-tests
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry-incubator/routing-release
- name: cf-acceptance-tests
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-acceptance-tests
- name: cf-deployment-master
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/cf-deployment.git
    private_key: {{cf_deployment_private_key}}
- name: stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-aws-xen-hvm-ubuntu-trusty-go_agent
- name: capi-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/capi-release
- name: nats-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/nats-release
- name: routing-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/cf-routing-release
- name: consul-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/consul-release
- name: etcd-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/etcd-release
- name: diego-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/diego-release
- name: loggregator-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/loggregator
- name: cf-mysql-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/cf-mysql-release
- name: uaa-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/uaa-release
- name: garden-runc-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/garden-runc-release
- name: binary-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/binary-buildpack-release
- name: dotnet-core-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/dotnet-core-buildpack-release
- name: go-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/go-buildpack-release
- name: java-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/java-buildpack-release
- name: nodejs-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/nodejs-buildpack-release
- name: php-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/php-buildpack-release
- name: python-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/python-buildpack-release
- name: ruby-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/ruby-buildpack-release
- name: staticfile-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/staticfile-buildpack-release
- name: statsd-injector-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/statsd-injector-release
- name: cflinuxfs2-rootfs-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/cflinuxfs2-rootfs-release
- name: cf-smoke-tests-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/cf-smoke-tests-release
- name: snitch-env-vars-store
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/snitch-env.git
    private_key: {{snitch_env_private_key}}
    paths:
    - deployment-vars.yml
- name: snitch-env-integration-configs
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/snitch-env.git
    private_key: {{snitch_env_private_key}}
    paths:
    - integration_config.json
    - rats_integration_config.json
- name: snitch-env-director-state
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/snitch-env.git
    private_key: {{snitch_env_private_key}}
    paths:
    - infrastructure/*
    - bbl-state.json
- name: bosh-deployment
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/bosh-deployment.git
- name: cats-concourse-task
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cats-concourse-task.git

jobs:
- name: setup-infrastructure-upgrade
  serial_groups: [hermione]
  public: true
  build_logs_to_retain: 100
  plan:
  - aggregate:
    - get: cf-deployment-concourse-tasks
    - get: hermione-env-director-state
    - get: runtime-ci
  - task: setup-infrastructure
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_IAAS: aws
      BBL_AWS_REGION: us-east-1
      BBL_AWS_ACCESS_KEY_ID: {{hermione_aws_access_key_id}}
      BBL_AWS_SECRET_ACCESS_KEY: {{hermione_aws_secret_access_key}}
      BBL_LB_CERT: {{hermione_lbs_ssl_cert}}
      BBL_LB_KEY: {{hermione_lbs_ssl_signing_key}}
      BBL_ENV_NAME: hermione-upgrade
    input_mapping:
      bbl-state: hermione-env-director-state
    ensure:
      put: hermione-env-director-state
      params:
        repository: updated-bbl-state
  - task: bind-elb-to-r53
    file: runtime-ci/scripts/ci/bind-elb-to-r53/task.yml
    input_mapping:
      env-repo: updated-bbl-state
    params:
      AWS_ACCESS_KEY_ID: {{hermione_aws_access_key_id}}
      AWS_SECRET_ACCESS_KEY: {{hermione_aws_secret_access_key}}
      DOMAIN: hermione.cf-app.com

- name: setup-infrastructure-fresh
  serial_groups: [luna]
  public: true
  build_logs_to_retain: 100
  plan:
  - get: runtime-ci
  - get: luna-env-director-state
  - get: cf-deployment-concourse-tasks
  - task: setup-infrastructure
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_IAAS: gcp
      BBL_GCP_SERVICE_ACCOUNT_KEY: google_account_creds.json
      BBL_GCP_PROJECT_ID: {{luna_gcp_project}}
      BBL_GCP_REGION: us-central1
      BBL_GCP_ZONE: us-central1-a
      BBL_LB_CERT: {{luna_cf_ssl_cert}}
      BBL_LB_KEY: {{luna_cf_ssl_cert_private_key}}
      LB_DOMAIN: luna.cf-app.com
      BBL_ENV_NAME: luna-fresh
    input_mapping:
      bbl-state: luna-env-director-state
    ensure:
      put: luna-env-director-state
      params:
        repository: updated-bbl-state
        rebase: true

- name: setup-infrastructure-lite
  serial_groups: [snitch]
  public: true
  build_logs_to_retain: 100
  plan:
  - get: runtime-ci
  - get: bosh-deployment
  - get: cf-deployment-develop
  - get: snitch-env-director-state
  - put: snitch-terraform
    params:
      env_name: snitch
      delete_on_failure: true
  - task: bosh-create-env
    file: runtime-ci/tasks/bosh-create-env/task.yml
    input_mapping:
      env-repo: snitch-env-director-state
      terraform: snitch-terraform
    params:
      STATE_FILE: infrastructure/bosh/state.json
      VARS_FILE: infrastructure/bosh/deployment-vars.yml
      OPS_FILES: "bosh-deployment/bosh-lite.yml bosh-deployment/bosh-lite-runc.yml bosh-deployment/jumpbox-user.yml bosh-deployment/gcp/bosh-lite-vm-type.yml"
      DIRECTOR_NAME: snitch
      GCP_PROJECTID: {{snitch_gcp_project}}
      GCP_CREDENTIALS: {{snitch_gcp_service_account_json}}
      GCP_ZONE: us-central1-a
  - put: snitch-env-director-state
    params:
      repository: updated-env-repo
      rebase: true
  - task: bbl-state-from-bosh-director-vars-store
    file: runtime-ci/scripts/ci/bbl-state-from-vars-store/task.yml
    input_mapping:
      env-repo: snitch-env-director-state
      terraform: snitch-terraform
  - put: snitch-env-director-state
    params:
      repository: updated-env-repo
      rebase: true
  - task: bosh-update-cloud-config
    file: runtime-ci/scripts/ci/bosh-update-cloud-config/task.yml
    input_mapping:
      bbl-state: snitch-env-director-state
      cloud-config: cf-deployment-develop
    params:
      CLOUD_CONFIG_FILE: bosh-lite/cloud-config.yml

- name: deploy-releases-fresh
  serial_groups: [luna, luna-routing]
  public: true
  build_logs_to_retain: 100
  plan:
  - aggregate:
    - get: runtime-ci
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment-develop
      trigger: true
    - get: luna-env-vars-store
    - get: luna-env-integration-configs
    - get: luna-env-director-state
      passed: [ setup-infrastructure-fresh ]
  - task: guarantee-no-existing-cf-deployment
    input_mapping:
      bbl-state: luna-env-director-state
    file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
  - task: bosh-upload-stemcell-fresh
    file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
    input_mapping:
      cf-deployment: cf-deployment-develop
      bbl-state: luna-env-director-state
    params:
      INFRASTRUCTURE: google
  - task: bosh-deploy-cf
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    input_mapping:
      bbl-state: luna-env-director-state
      cf-deployment: cf-deployment-develop
      ops-files: cf-deployment-develop
      vars-store: luna-env-vars-store
    params:
      SYSTEM_DOMAIN: luna.cf-app.com
      OPS_FILES: "operations/gcp.yml operations/tcp-routing-gcp.yml operations/test/add-persistent-isolation-segment-diego-cell.yml"
      REGENERATE_VARS_STORE: true
    ensure:
      put: luna-env-vars-store
      params:
        repository: updated-vars-store
        rebase: true
  - task: run-bosh-cleanup
    file: runtime-ci/scripts/ci/run-bosh-cleanup/task.yml
    input_mapping:
      bbl-state: luna-env-director-state
  - task: update-integration-configs
    file: cf-deployment-concourse-tasks/update-integration-configs/task.yml
    params:
      CATS_INTEGRATION_CONFIG_FILE: integration_config.json
    input_mapping:
      vars-store: luna-env-vars-store
      integration-configs: luna-env-integration-configs
    ensure:
      put: luna-env-integration-configs
      params:
        repository: updated-integration-configs
        rebase: true

- name: deploy-releases-upgrade
  serial_groups: [hermione]
  public: true
  build_logs_to_retain: 100
  plan:
  - aggregate:
    - get: runtime-ci
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment-develop
      trigger: true
    - get: hermione-env-vars-store
    - get: hermione-env-director-state
      passed: [ setup-infrastructure-upgrade ]
    - get: hermione-env-integration-configs
    - get: windows-stemcell
  - task: bosh-upload-stemcell-upgrade
    file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
    input_mapping:
      cf-deployment: cf-deployment-develop
      bbl-state: hermione-env-director-state
    params:
      INFRASTRUCTURE: aws
  - task: bosh-upload-windows-stemcell
    file: runtime-ci/scripts/ci/bosh-upload-stemcell/task.yml
    input_mapping:
      stemcell: windows-stemcell
      bbl-state: hermione-env-director-state
    params:
      STEMCELL_NAME: '*.tgz'
  - task: bosh-deploy-cf
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    input_mapping:
      bbl-state: hermione-env-director-state
      cf-deployment: cf-deployment-develop
      ops-files: cf-deployment-develop
      vars-store: hermione-env-vars-store
    params:
      SYSTEM_DOMAIN: hermione.cf-app.com
      OPS_FILES: "operations/change-logging-port-for-aws-elb.yml operations/windows-cell.yml operations/use-only-local-route-emitters.yml"
    ensure:
      put: hermione-env-vars-store
      params:
        repository: updated-vars-store
        rebase: true
  - task: run-bosh-cleanup
    file: runtime-ci/scripts/ci/run-bosh-cleanup/task.yml
    input_mapping:
      bbl-state: hermione-env-director-state
  - task: update-integration-configs
    file: cf-deployment-concourse-tasks/update-integration-configs/task.yml
    params:
      CATS_INTEGRATION_CONFIG_FILE: integration_config.json
    input_mapping:
      vars-store: hermione-env-vars-store
      integration-configs: hermione-env-integration-configs
    ensure:
      put: hermione-env-integration-configs
      params:
        repository: updated-integration-configs
        rebase: true

- name: deploy-releases-lite
  public: true
  serial_groups: [snitch]
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: cf-deployment-develop
        trigger: true
      - get: bosh-deployment
      - get: snitch-env-director-state
        passed: [ setup-infrastructure-lite ]
      - get: snitch-env-vars-store
      - get: snitch-env-integration-configs
    - task: guarantee-no-existing-cf-deployment
      input_mapping:
        bbl-state: snitch-env-director-state
      file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
    - task: bosh-upload-stemcell-lite
      file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
      input_mapping:
        cf-deployment: cf-deployment-develop
        bbl-state: snitch-env-director-state
      params:
        INFRASTRUCTURE: bosh-lite
    - task: bosh-deploy-cf-deployment
      file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
      input_mapping:
        bbl-state: snitch-env-director-state
        cf-deployment: cf-deployment-develop
        vars-store: snitch-env-vars-store
        ops-files: cf-deployment-develop
      params:
        SYSTEM_DOMAIN: snitch.cf-app.com
        OPS_FILES: "operations/bosh-lite.yml"
      ensure:
        put: snitch-env-vars-store
        params:
          repository: updated-vars-store
          rebase: true
    - task: run-bosh-cleanup
      file: runtime-ci/scripts/ci/run-bosh-cleanup/task.yml
      input_mapping:
        bbl-state: snitch-env-director-state
    - task: update-integration-configs
      file: cf-deployment-concourse-tasks/update-integration-configs/task.yml
      params:
        CATS_INTEGRATION_CONFIG_FILE: integration_config.json
      input_mapping:
        vars-store: snitch-env-vars-store
        integration-configs: snitch-env-integration-configs
      ensure:
        put: snitch-env-integration-configs
        params:
          repository: updated-integration-configs
          rebase: true
    - task: ensure-api-healthy
      file: runtime-ci/scripts/ci/wait-for-endpoint/task.yml
      params:
        ENDPOINT: api.snitch.cf-app.com

- name: acceptance-tests-upgrade
  serial_groups: [hermione]
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: cf-acceptance-tests
      - get: hermione-env-director-state
        trigger: true
        passed: [ deploy-releases-upgrade ]
      - get: hermione-env-integration-configs
        trigger: true
      - get: hermione-env-vars-store
        trigger: true
        passed: [ deploy-releases-upgrade ]
      - get: cf-deployment-develop
        trigger: true
        passed: [ deploy-releases-upgrade ]
      - get: cats-concourse-task
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      input_mapping:
        vars-store: hermione-env-vars-store
      params:
        SYSTEM_DOMAIN: hermione.cf-app.com
    - task: run-cats
      input_mapping:
      - integration-config: hermione-env-integration-configs
      file: cats-concourse-task/task.yml

- name: acceptance-tests-fresh
  serial_groups: [luna]
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: cf-acceptance-tests
      - get: cf-deployment-develop
        trigger: true
        passed: [ deploy-releases-fresh ]
      - get: luna-env-director-state
        trigger: true
        passed: [ deploy-releases-fresh ]
      - get: luna-env-vars-store
        trigger: true
        passed: [ deploy-releases-fresh ]
      - get: luna-env-integration-configs
        trigger: true
      - get: cats-concourse-task
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      input_mapping:
        vars-store: luna-env-vars-store
      params:
        SYSTEM_DOMAIN: luna.cf-app.com
    - task: run-cats
      input_mapping:
      - integration-config: luna-env-integration-configs
      params:
        NODES: 6
      file: cats-concourse-task/task.yml

- name: acceptance-tests-lite
  serial_groups: [snitch]
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: cf-acceptance-tests
      - get: cf-deployment-develop
        trigger: true
        passed: [ deploy-releases-lite ]
      - get: snitch-env-director-state
        trigger: true
        passed: [ deploy-releases-lite ]
      - get: snitch-env-vars-store
        trigger: true
        passed: [ deploy-releases-lite ]
      - get: snitch-env-integration-configs
        trigger: true
      - get: cats-concourse-task
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      input_mapping:
        vars-store: snitch-env-vars-store
      params:
        SYSTEM_DOMAIN: snitch.cf-app.com
    - task: run-cats
      input_mapping:
      - integration-config: snitch-env-integration-configs
      params:
        NODES: 6
      file: cats-concourse-task/task.yml

- name: routing-acceptance-tests-fresh
  serial_groups: [luna-routing]
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: routing-acceptance-tests
      - get: luna-env-director-state
        trigger: true
        passed: [ deploy-releases-fresh ]
      - get: luna-env-vars-store
        trigger: true
        passed: [ deploy-releases-fresh ]
      - get: luna-env-integration-configs
        trigger: true
      - get: cf-deployment-develop
        trigger: true
        passed: [ deploy-releases-fresh ]
    - task: ensure-tcp-router-healthy
      file: runtime-ci/scripts/ci/wait-for-endpoint/task.yml
      params:
        ENDPOINT: tcp.luna.cf-app.com:8080/health
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      input_mapping:
        vars-store: luna-env-vars-store
      params:
        SYSTEM_DOMAIN: luna.cf-app.com
    - task: run-rats
      input_mapping:
      - routing-release: routing-acceptance-tests
      - integration-config: luna-env-integration-configs
      file: runtime-ci/scripts/ci/run-rats/task.yml

- name: post-delete-deployment-fresh
  serial_groups: [luna, luna-routing]
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - aggregate:
      - get: runtime-ci
      - get: luna-env-director-state
        trigger: true
        passed:
        - acceptance-tests-fresh
        - routing-acceptance-tests-fresh
      - get: cf-deployment-develop
        trigger: true
        passed:
        - acceptance-tests-fresh
        - routing-acceptance-tests-fresh
      - get: luna-env-vars-store
        trigger: true
        passed:
        - acceptance-tests-fresh
        - routing-acceptance-tests-fresh
      - get: luna-env-integration-configs
        trigger: true
        passed:
        - acceptance-tests-fresh
        - routing-acceptance-tests-fresh
      - get: cf-deployment-concourse-tasks
    - task: delete-deployment-cf
      input_mapping:
        bbl-state: luna-env-director-state
      file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml

- name: destroy-infrastructure-upgrade
  serial_groups: [hermione]
  public: true
  build_logs_to_retain: 100
  plan:
  - aggregate:
    - get: hermione-env-director-state
    - get: runtime-ci
    - get: cf-deployment-concourse-tasks
  - task: guarantee-no-existing-cf-deployment
    input_mapping:
      bbl-state: hermione-env-director-state
    file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
  - task: unbind-elb-from-r53
    file: runtime-ci/scripts/ci/unbind-elb-from-r53/task.yml
    input_mapping:
      env-repo: hermione-env-director-state
    params:
      AWS_ACCESS_KEY_ID: {{hermione_aws_access_key_id}}
      AWS_SECRET_ACCESS_KEY: {{hermione_aws_secret_access_key}}
      DOMAIN: hermione.cf-app.com
  - task: destroy-infrastructure
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    input_mapping:
      bbl-state: hermione-env-director-state
    ensure:
      put: hermione-env-director-state
      params:
        repository: updated-bbl-state

- name: destroy-infrastructure-fresh
  serial_groups: [luna]
  public: true
  build_logs_to_retain: 100
  plan:
  - aggregate:
    - get: luna-env-director-state
    - get: runtime-ci
    - get: cf-deployment-concourse-tasks
  - task: guarantee-no-existing-cf-deployment
    input_mapping:
      bbl-state: luna-env-director-state
    file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
  - task: destroy-infrastructure
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    input_mapping:
      bbl-state: luna-env-director-state
    ensure:
      put: luna-env-director-state
      params:
        repository: updated-bbl-state
        rebase: true

- name: destroy-infrastructure-lite
  serial_groups: [snitch]
  public: true
  build_logs_to_retain: 100
  plan:
  - aggregate:
    - get: runtime-ci
    - get: snitch-terraform
    - get: bosh-deployment
    - get: snitch-env-director-state
  - task: bosh-delete-env-lite
    file: runtime-ci/tasks/bosh-delete-env/task.yml
    input_mapping:
      env-repo: snitch-env-director-state
    input_mapping:
      env-repo: snitch-env-director-state
      bosh-deployment: bosh-deployment
      terraform: snitch-terraform
    params:
      STATE_FILE: infrastructure/bosh/state.json
      VARS_FILE: infrastructure/bosh/deployment-vars.yml
      OPS_FILES: "bosh-deployment/bosh-lite.yml"
      DIRECTOR_NAME: snitch
      GCP_PROJECTID: {{snitch_gcp_project}}
      GCP_CREDENTIALS: {{snitch_gcp_service_account_json}}
      GCP_ZONE: us-central1-a
  - put: snitch-env-director-state
    params:
      repository: updated-env-repo
      rebase: true
  - put: snitch-terraform
    params:
      env_name: snitch
      action: destroy
    get_params:
      action: destroy

- name: bless-manifest
  public: true
  serial: true
  build_logs_to_retain: 100
  plan:
    - do:
      - aggregate:
        - get: cf-deployment-develop
          trigger: true
          passed:
          - acceptance-tests-upgrade
          - acceptance-tests-fresh
          - routing-acceptance-tests-fresh
          - acceptance-tests-lite
        - get: cf-deployment-master
    - put: cf-deployment-release-candidate
      params:
        repository: cf-deployment-develop
    - put: cf-deployment-master
      params:
        repository: cf-deployment-release-candidate

- name: update-releases
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - aggregate:
    - get: runtime-ci
    - get: hermione-env-director-state
    - get: greengrass-env-director-state
    - get: cf-deployment-develop
    - get: stemcell
      trigger: true
      params:
        tarball: false
    - get: capi-release
      trigger: true
      params:
        tarball: false
    - get: nats-release
      trigger: true
      params:
        tarball: false
    - get: routing-release
      trigger: true
      params:
        tarball: false
    - get: consul-release
      trigger: true
      params:
        tarball: false
    - get: etcd-release
      trigger: true
      params:
        tarball: false
    - get: diego-release
      trigger: true
      params:
        tarball: false
    - get: loggregator-release
      trigger: true
      params:
        tarball: false
    - get: cf-mysql-release
      trigger: true
      params:
        tarball: false
    - get: uaa-release
      trigger: true
      params:
        tarball: false
    - get: garden-runc-release
      trigger: true
      params:
        tarball: false
    - get: cflinuxfs2-rootfs-release
      trigger: true
      params:
        tarball: false
    - get: binary-buildpack-release
      trigger: true
      params:
        tarball: false
    - get: dotnet-core-buildpack-release
      trigger: true
      params:
        tarball: false
    - get: go-buildpack-release
      trigger: true
      params:
        tarball: false
    - get: java-buildpack-release
      trigger: true
      params:
        tarball: false
    - get: nodejs-buildpack-release
      trigger: true
      params:
        tarball: false
    - get: php-buildpack-release
      trigger: true
      params:
        tarball: false
    - get: python-buildpack-release
      trigger: true
      params:
        tarball: false
    - get: ruby-buildpack-release
      trigger: true
      params:
        tarball: false
    - get: staticfile-buildpack-release
      trigger: true
      params:
        tarball: false
    - get: statsd-injector-release
      trigger: true
      params:
        tarball: false
    - get: cf-smoke-tests-release
      trigger: true
      params:
        tarball: false
  - task: create-binaries-manifest-section
    file: runtime-ci/scripts/ci/create-binaries-manifest-section/task.yml
    input_mapping:
      deployment-configuration: cf-deployment-develop
  - task: bosh-dry-run
    file: runtime-ci/tasks/bosh-dry-run/task.yml
    input_mapping:
      bbl-state: greengrass-env-director-state
      cf-deployment: deployment-manifest
      ops-files: cf-deployment-develop
  - task: commit-generated-manifest
    file: runtime-ci/scripts/ci/commit-generated-manifest/task.yml
    input_mapping:
      repo: cf-deployment-develop
      manifest: deployment-manifest
    params:
      MANIFEST_NAME: cf-deployment.yml
      MANIFEST_DESTINATION: cf-deployment.yml
  - put: cf-deployment-develop
    params:
      repository: updated-repo

- name: verify-nameserver-has-record
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - get: runtime-ci
    - get: weekly
      trigger: true
    - task: verify-nameserver-has-record
      file: runtime-ci/scripts/ci/verify-nameserver-has-record/task.yml
      params:
        AWS_ACCESS_KEY_ID: {{hermione_aws_access_key_id}}
        AWS_SECRET_ACCESS_KEY: {{hermione_aws_secret_access_key}}
        DOMAIN: hermione.cf-app.com

- name: run-bosh-cleanup-upgrade
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - aggregate:
      - get: runtime-ci
      - get: hermione-env-director-state
      - get: daily
        trigger: true
    - task: run-bosh-cleanup
      file: runtime-ci/scripts/ci/run-bosh-cleanup/task.yml
      input_mapping:
        bbl-state: hermione-env-director-state

- name: run-bosh-cleanup-lite
  serial: true
  public: true
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - aggregate:
      - get: runtime-ci
      - get: snitch-env-director-state
      - get: daily
        trigger: true
    - task: run-bosh-cleanup
      file: runtime-ci/scripts/ci/run-bosh-cleanup/task.yml
      input_mapping:
        bbl-state: snitch-env-director-state
