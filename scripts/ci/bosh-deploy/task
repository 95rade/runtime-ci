#!/bin/bash
set -eux

BOSH_TARGET=$(cat "target/${TARGET_FILE}")
export BOSH_USER=$(cat username/"${USERNAME_FILE}")
BOSH_MANIFEST="manifest/${MANIFEST_FILE}"
set +x
export BOSH_PASSWORD=$(cat "password/${PASSWORD_FILE}")
BOSH_CA_CERT="ca-cert/${CA_CERT_FILE}"
DEPLOYMENT_NAME=$(grep -E "^name:" "$BOSH_MANIFEST" | awk '{print $2}')

deployment_vars_store_argument=""

ops_file_arguments=""
for op in ${OPS_FILES}
do
  ops_file_arguments="${ops_file_arguments} -o manifest/${op}"
done

if [ "${DEPLOYMENT_VARS_STORE}" != "" ]; then
  deployment_vars_store_argument="--vars-store manifest-properties/${DEPLOYMENT_VARS_STORE} -v system_domain=${SYSTEM_DOMAIN}"
fi

function commit_vars_store {
  pushd manifest-properties
    if [[ -n $(git status --porcelain) ]]; then
      git config user.name "CF MEGA BOT"
      git config user.email "cf-mega@pivotal.io"
      git add .
      git commit -m "Update vars store"
    fi
  popd

  shopt -s dotglob
  cp -R manifest-properties/* updated-vars-store/
}

trap commit_vars_store EXIT

echo "bosh -n -d ${DEPLOYMENT_NAME} -e ${BOSH_TARGET} --ca-cert=${BOSH_CA_CERT} deploy ${deployment_vars_store_argument} ${ops_file_arguments} ${BOSH_MANIFEST}"
bosh -n interpolate ${deployment_vars_store_argument} ${ops_file_arguments} --var-errs ${BOSH_MANIFEST} > /dev/null

set +e
echo "Here are all the unmodified static IP addresses left in this manifest after applying all bosh operations:"
bosh -n interpolate ${deployment_vars_store_argument} ${ops_file_arguments} --var-errs ${BOSH_MANIFEST} | grep -E '10\.0\.31\.190|10\.0\.47\.190|10\.0\.63\.190|10\.0\.31\.191|10\.0\.47\.191|10\.0\.31\.193'
set -e

if [ "${DEPLOYMENT_VARS_STORE}" != "" ]; then
  set +x
  CF_PASSWORD=$(bosh int manifest-properties/${DEPLOYMENT_VARS_STORE} --path=/uaa_scim_users_admin_password)
  cat manifest-properties/integration_config_template.json | \
    sed "s/REPLACE_ME/\"${CF_PASSWORD}\"/" \
    > manifest-properties/integration_config.json
  if [ -f manifest-properties/rats_integration_config_template.json ]; then
    TCP_EMITTER_SECRET=$(bosh int manifest-properties/${DEPLOYMENT_VARS_STORE} --path=/uaa_clients_tcp_emitter_secret)
    cat manifest-properties/rats_integration_config_template.json | \
      sed "s/CF_ADMIN_PASSWORD/\"${CF_PASSWORD}\"/" | \
      sed "s/TCP_EMITTER_SECRET/\"${TCP_EMITTER_SECRET}\"/" \
      > manifest-properties/rats_integration_config.json
  fi
  set -x
fi

bosh \
  -n \
  -d "${DEPLOYMENT_NAME}" \
  -e "${BOSH_TARGET}" \
  --ca-cert="${BOSH_CA_CERT}" \
  deploy \
  $deployment_vars_store_argument \
  $ops_file_arguments \
  "${BOSH_MANIFEST}"

set -x
