#!/bin/bash
set -eux

export BOSH_USER
export BOSH_PASSWORD
BOSH_USER=$(cat "username/${USERNAME_FILE}")
BOSH_TARGET=$(cat "target/${TARGET_FILE}")
BOSH_MANIFEST="manifest/${MANIFEST_FILE}"
BOSH_CA_CERT="ca-cert/${CA_CERT_FILE}"
DEPLOYMENT_NAME=$(grep -E "^name:" "$BOSH_MANIFEST" | awk '{print $2}')
RELEASE_NAME=$(grep final_name release/config/final.yml | awk '{print $2}')

set +u
DEPLOYMENT_VAR_FILE="manifest-properties/${DEPLOYMENT_VAR_FILE}"
set -u

set +x
echo "BOSH_PASSWORD=\$(cat password/${PASSWORD_FILE})"
BOSH_PASSWORD=$(cat "password/${PASSWORD_FILE}")
set -x

cat << EOF > ops.yml
---
- type: replace
  path: /releases/name=${release_name}
  value:
    name: ${release_name}
    version: create
    url: file://$(pwd)/release
eof

if [[ -f $deployment_var_file ]]; then
  bosh \
    -n \
    -d "${deployment_name}" \
    -e "${bosh_target}" \
    --ca-cert="${bosh_ca_cert}" \
    deploy \
    --var-files="${deployment_var_file}" \
    -o ops.yml \
    "${bosh_manifest}"
else
  bosh \
    -n \
    -d "${deployment_name}" \
    -e "${bosh_target}" \
    --ca-cert="${bosh_ca_cert}" \
    deploy \
    -o ops.yml \
    "${bosh_manifest}"
fi
