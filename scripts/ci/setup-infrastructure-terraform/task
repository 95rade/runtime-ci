#!/bin/bash

# This concourse task results in:
# 1. A terraformed GCP environment
# 2. Bosh create-env manifest complete with ca-certs, credentials, etc.
# 3. Files for targeting the new bosh director when deployed
set -xeu

export DIRECTOR_PASSWORD=`openssl rand -base64 32`
export DIRECTOR_USERNAME=user-`openssl rand -base64 32`
export DIRECTOR_SSH_KEY_PATH=keys/ssh-key

function commit {
  pushd env-repo
    if [[ -n $(git status --porcelain) ]]; then
      git config user.name "CF MEGA BOT"
      git config user.email "cf-mega@pivotal.io"
      git add .
      git commit -m "Commit terraform state and bosh ops file"
    fi
  popd
}

root_dir=$PWD
infrastructure_task_dir=${root_dir}/runtime-ci/scripts/ci/setup-infrastructure-terraform/

pushd env-repo/infrastructure
  pushd terraform
    set +x
    echo 'terraform apply'
    export GOOGLE_CREDENTIALS=$(cat google_credentials.json)
    terraform apply
    gcloud config set project cf-release-integration-141222
    gcloud config set compute/region us-west1
    gcloud config set compute/zone us-west1-a
    gcloud auth activate-service-account 815441650186-compute@developer.gserviceaccount.com --key-file google_credentials.json
    export DIRECTOR_IP=$(gcloud compute addresses describe dobby-director-address | grep address: | awk '{print $2}')
  popd
  pushd bosh-init
    if [ ! -e ${DIRECTOR_SSH_KEY_PATH} ]; then
      mkdir -p `dirname ${DIRECTOR_SSH_KEY_PATH}`
      ssh-keygen -t rsa -f ${DIRECTOR_SSH_KEY_PATH} -C vcap  -N ""
      paste -d: <(echo vcap) ${DIRECTOR_SSH_KEY_PATH}.pub > ${DIRECTOR_SSH_KEY_PATH}.gcp_pub
      gcloud compute project-info add-metadata --metadata-from-file sshKeys=${DIRECTOR_SSH_KEY_PATH}.gcp_pub
    fi

    ${infrastructure_task_dir}/generate-certs.sh director ${DIRECTOR_IP} ${root_dir}/env-repo/infrastructure/bosh-init

    echo ${DIRECTOR_USERNAME} > username
    echo ${DIRECTOR_PASSWORD} > password
    echo ${DIRECTOR_IP} > target
  popd
popd

cat << EOF > ${root_dir}/env-repo/infrastructure/bosh-init/deployment-env-vars.yml
---
google_credentials: |+
  $(cat ${root_dir}/env-repo/infrastructure/terraform/google_credentials.json | ruby -p -e 'gsub("\n", "\n  ")')
director_cert: |+
  $(cat ${root_dir}/env-repo/infrastructure/bosh-init/certs/director.crt | ruby -p -e 'gsub("\n", "\n  ")')
director_key: |+
  $(cat ${root_dir}/env-repo/infrastructure/bosh-init/certs/director.key | ruby -p -e 'gsub("\n", "\n  ")')
director_username: ${DIRECTOR_USERNAME}
director_password: ${DIRECTOR_PASSWORD}
director_ip: ${DIRECTOR_IP}
director_mbus_address: "https://mbus:mbus-password@${DIRECTOR_IP}:6868"
director_ssh_key_path: ${DIRECTOR_SSH_KEY_PATH}
EOF

echo 'commit'
commit
set -x

shopt -s dotglob
cp -R env-repo/* updated-env-repo/
