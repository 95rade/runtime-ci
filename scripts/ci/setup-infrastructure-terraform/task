#!/bin/bash

# This concourse task results in:
# 1. A terraformed GCP environment
# 2. Bosh create-env manifest complete with ca-certs, credentials, etc.
# 3. Files for targeting the new bosh director when deployed
set -xeu

export DIRECTOR_PASSWORD=`openssl rand -base64 32`
export DIRECTOR_USERNAME=user-`openssl rand -base64 32`

function commit {
  pushd env-repo
    if [[ -n $(git status --porcelain) ]]; then
      git config user.name "CF MEGA BOT"
      git config user.email "cf-mega@pivotal.io"
      git add .
      git commit -m "Commit terraform state and bosh manifest"
    fi
  popd
}

root_dir=$PWD
infrastructure_task_dir=${root_dir}/runtime-ci/scripts/ci/setup-infrastructure-terraform/

pushd env-repo/infrastructure
  pushd terraform
    set +x
    echo 'terraform apply'
    export GOOGLE_CREDENTIALS=$(cat google_credentials.json)
    terraform apply
    gcloud config set project cf-release-integration-141222
    gcloud config set compute/region us-west1
    gcloud config set compute/zone us-west1-a
    gcloud auth activate-service-account 815441650186-compute@developer.gserviceaccount.com --key-file google_credentials.json
    export DIRECTOR_IP=$(gcloud compute addresses describe dobby-director-address | grep address: | awk '{print $2}')
  popd
  pushd bosh-init
    if [ ! -e ${DIRECTOR_SSH_KEY_PATH} ]; then
      mkdir -p `dirname ${DIRECTOR_SSH_KEY_PATH}`
      ssh-keygen -t rsa -f ${DIRECTOR_SSH_KEY_PATH} -C vcap  -N ""
      paste -d: <(echo vcap) ${DIRECTOR_SSH_KEY_PATH}.pub > ${DIRECTOR_SSH_KEY_PATH}.gcp_pub
      gcloud compute project-info add-metadata --metadata-from-file sshKeys=${DIRECTOR_SSH_KEY_PATH}.gcp_pub
    fi

    ${infrastructure_task_dir}/generate-certs.sh director ${DIRECTOR_IP} ${root_dir}/env-repo/infrastructure/bosh-init

cat << EOF > ${root_dir}/env-repo/infrastructure/bosh-init/ops.yml
---
- type: replace
  path: /jobs/name=bosh/properties/director/ssl
  value:
    cert: |+
      $(cat ${root_dir}/env-repo/infrastructure/bosh-init/certs/director.crt | ruby -p -e 'gsub("\n", "\n      ")')
    key: |+
      $(cat ${root_dir}/env-repo/infrastructure/bosh-init/certs/director.key | ruby -p -e 'gsub("\n", "\n      ")')
- type: replace
  path: /jobs/name=bosh/properties/director/user_management/local/users
  value:
  - name: ${DIRECTOR_USERNAME}
    password: ${DIRECTOR_PASSWORD}
  - name: hm
    password: hm-password
- type: replace
  path: /jobs/name=bosh/networks/name=vip/static_ips
  value: [${DIRECTOR_IP}]
- type: replace
  path: /cloud_provider/ssh_tunnel/host
  value: ${DIRECTOR_IP}
- type: replace
  path: /cloud_provider/ssh_tunnel/private_key
  value: ${DIRECTOR_SSH_KEY_PATH}
- type: replace
  path: /cloud_provider/mbus
  value: "https://mbus:mbus-password@${DIRECTOR_IP}:6868"
EOF
  popd
popd

echo 'commit'
commit
set -x

shopt -s dotglob
cp -R env-repo/* updated-env-repo/
echo $DIRECTOR_USERNAME > bosh-username/${USERNAME_FILE}
echo $DIRECTOR_PASSWORD > bosh-password/${PASSWORD_FILE}
cp env-repo/infrastructure/bosh-init/certs/rootCA.pem bosh-ca-cert/${CA_CERT_FILE}
