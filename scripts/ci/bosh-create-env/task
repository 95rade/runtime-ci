#!/bin/bash
set -eux

DEPLOYMENT_VAR_FILE="${DEPLOYMENT_VAR_FILE:?"DEPLOYMENT_VAR_FILE must be provided"}"

export BOSH_USER=$(cat username/"${USERNAME_FILE}")
export BOSH_PASSWORD=$(cat "password/${PASSWORD_FILE}")

bosh -n interpolate --var-file=env-repo/${DEPLOYMENT_VAR_FILE} --var-errs env-repo/${DIRECTOR_MANIFEST_FILE} > /dev/null

set -x
bosh -n create-env --var-file=env-repo/${DEPLOYMENT_VAR_FILE} env-repo/${DIRECTOR_MANIFEST_FILE}

pushd env-repo
  STATE_FILE_PATH=${DIRECTOR_MANIFEST_FILE%%.yml}-state.json
  if [[ -n $(git status --porcelain) ]]; then
    git config user.name "CF MEGA BOT"
    git config user.email "cf-mega@pivotal.io"
    git add ${STATE_FILE_PATH}
    git commit -m "Commit bosh state file"
  fi
popd

shopt -s dotglob
cp -R env-repo/* updated-env-repo/

