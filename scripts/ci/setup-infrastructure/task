#!/bin/bash

set -xeu

function commit_bbl_state_file {
  set -x
  if [[ -n $(git status --porcelain) ]]; then
    git config user.name "CF MEGA BOT"
    git config user.email "cf-mega@pivotal.io"
    git add bbl-infrastructure
    git commit -m "Update bbl artifacts"
  fi

  shopt -s dotglob
  cp -R env-repo/* updated-env-repo/
}

trap commit_bbl_state_file EXIT

pushd env-repo
  set +x
  echo "bbl \
    --state-dir bbl-infrastructure \
    --aws-access-key-id [REDACTED] \
    --aws-secret-access-key [REDACTED] \
    --aws-region us-east-1 \
    unsupported-deploy-bosh-on-aws-for-concourse"
  bbl \
    --state-dir bbl-infrastructure \
    --aws-access-key-id "$AWS_ACCESS_KEY_ID" \
    --aws-secret-access-key "$AWS_SECRET_ACCESS_KEY" \
    --aws-region us-east-1 \
    unsupported-deploy-bosh-on-aws-for-concourse

  if [[ -n "$BBL_LB_CERT" && -n "$BBL_LB_KEY" ]]; then
    echo "$BBL_LB_CERT" > /tmp/bbl-cert
    echo "$BBL_LB_KEY" > /tmp/bbl-key

    echo "bbl \
      --state-dir bbl-infrastructure \
      --aws-access-key-id [REDACTED] \
      --aws-secret-access-key [REDACTED] \
      --aws-region us-east-1 \
      unsupported-create-lbs \
      --type=cf \
      --cert=/tmp/bbl-cert \
      --key=/tmp/bbl-key \
      --skip-if-exists"

    bbl \
      --state-dir bbl-infrastructure \
      --aws-access-key-id "$AWS_ACCESS_KEY_ID" \
      --aws-secret-access-key "$AWS_SECRET_ACCESS_KEY" \
      --aws-region us-east-1 \
      unsupported-create-lbs \
      --type=cf \
      --cert=/tmp/bbl-cert \
      --key=/tmp/bbl-key \
      --skip-if-exists
  fi
popd
